{% extends 'pandora_ultra_modern_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Devolução de Material{% endblock %}

{% block extra_css %}
<style>
    .devolucao-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dc3545;
    }
    .devolucao-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .funcionario-info {
        background: linear-gradient(135deg, #fd7e14 0%, #dc3545 100%);
        border-radius: 10px;
        color: white;
    }
    .btn-devolver {
        background: linear-gradient(45deg, #dc3545, #fd7e14);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .btn-devolver:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
    }
    .responsabilidade-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 15px;
    }
    .material-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 10px;
        margin-bottom: 10px;
    }
    .badge-dias {
        font-size: 0.75em;
        padding: 4px 8px;
    }
    .status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-undo text-danger me-2"></i>
                        Devolução de Material
                    </h1>
                    <p class="text-muted">Controle de devoluções de materiais ao almoxarifado</p>
                </div>
                <div class="btn-group">
                    <a href="{% url 'funcionarios_estoque:dashboard_materiais' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                    <a href="{% url 'funcionarios_estoque:responsabilidade_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-list me-1"></i> Responsabilidades
                    </a>
                </div>
            </div>

            <!-- Formulário de Devolução -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-hand-holding me-2"></i>
                                Nova Devolução
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="post" id="devolucaoForm">
                                {% csrf_token %}
                                
                                <!-- Seleção do Funcionário -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-user text-primary me-1"></i>
                                        Funcionário *
                                    </label>
                                    <select name="funcionario" class="form-select" required id="funcionarioSelect">
                                        <option value="">Selecione o funcionário...</option>
                                        {% for funcionario in funcionarios_com_responsabilidade %}
                                        <option value="{{ funcionario.id }}" 
                                                data-nome="{{ funcionario.nome_completo }}"
                                                data-departamento="{{ funcionario.departamento.name|default:'N/A' }}"
                                                data-materiais="{{ funcionario.responsabilidades_ativas.count }}">
                                            {{ funcionario.nome_completo }} 
                                            <span class="text-muted">({{ funcionario.responsabilidades_ativas.count }} material{{ funcionario.responsabilidades_ativas.count|pluralize }})</span>
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Informações do Funcionário Selecionado -->
                                <div id="funcionarioInfo" class="funcionario-info p-3 mb-4" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">
                                                <i class="fas fa-user-check me-1"></i>
                                                <span id="funcionarioNome"></span>
                                            </h6>
                                            <p class="mb-1">
                                                <i class="fas fa-building me-1"></i>
                                                Departamento: <span id="funcionarioDepartamento"></span>
                                            </p>
                                            <p class="mb-0">
                                                <i class="fas fa-boxes me-1"></i>
                                                Materiais sob responsabilidade: <span id="funcionarioMateriais"></span>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Materiais para Devolução -->
                                <div id="materiaisContainer" class="mb-4" style="display: none;">
                                    <h6 class="mb-3">
                                        <i class="fas fa-clipboard-list text-info me-1"></i>
                                        Materiais Disponíveis para Devolução
                                    </h6>
                                    <div id="materiaisList">
                                        <!-- Será preenchido via AJAX -->
                                    </div>
                                </div>

                                <!-- Motivo da Devolução -->
                                <div class="row mb-4" id="motivoSection" style="display: none;">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Motivo da Devolução *</label>
                                        <select name="motivo_devolucao" class="form-select" required>
                                            <option value="">Selecione o motivo...</option>
                                            <option value="trabalho_concluido">Trabalho Concluído</option>
                                            <option value="material_danificado">Material Danificado</option>
                                            <option value="material_inadequado">Material Inadequado</option>
                                            <option value="fim_projeto">Fim do Projeto</option>
                                            <option value="transferencia">Transferência de Função</option>
                                            <option value="manutencao">Envio para Manutenção</option>
                                            <option value="outros">Outros</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Depósito de Destino *</label>
                                        <select name="deposito_destino" class="form-select" required>
                                            <option value="">Selecione o depósito...</option>
                                            {% for deposito in depositos %}
                                            <option value="{{ deposito.id }}">{{ deposito.nome }} ({{ deposito.codigo }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div id="observacoesSection" class="mb-4" style="display: none;">
                                    <label class="form-label fw-bold">Observações sobre a Devolução</label>
                                    <textarea name="observacoes" class="form-control" rows="3" placeholder="Descreva o estado do material, motivos adicionais, etc..."></textarea>
                                </div>

                                <!-- Botões -->
                                <div id="botoesSection" class="d-flex justify-content-end gap-2" style="display: none;">
                                    <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                                        <i class="fas fa-times me-1"></i>
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-devolver">
                                        <i class="fas fa-check me-1"></i>
                                        Confirmar Devolução
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sidebar com Informações -->
                <div class="col-lg-4">
                    <!-- Devoluções Recentes -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-clock text-primary me-1"></i>
                                Devoluções Recentes
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for devolucao in devolucoes_recentes %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong class="text-dark">{{ devolucao.funcionario.nome_completo }}</strong>
                                            <br>
                                            <small class="text-muted">{{ devolucao.produto.nome|truncatechars:30 }}</small>
                                            <br>
                                            <small class="text-success">{{ devolucao.data_devolucao|timesince }} atrás</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-success">{{ devolucao.quantidade }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Nenhuma devolução recente
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Alertas de Materiais -->
                    <div class="card shadow">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                Alertas de Responsabilidade
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for alerta in materiais_em_atraso %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong class="text-danger">{{ alerta.funcionario.nome_completo }}</strong>
                                            <br>
                                            <small class="text-muted">{{ alerta.produto.nome|truncatechars:25 }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-danger badge-dias">
                                                {{ alerta.dias_atraso }} dias
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center text-muted">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Nenhum material em atraso
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para Item de Material -->
<template id="materialItemTemplate">
    <div class="responsabilidade-item position-relative">
        <div class="row align-items-center">
            <div class="col-md-1">
                <input type="checkbox" name="materiais_devolver[]" class="form-check-input material-checkbox" value="">
            </div>
            <div class="col-md-4">
                <div class="material-info">
                    <strong class="produto-nome"></strong>
                    <br>
                    <small class="text-muted produto-codigo"></small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="text-center">
                    <strong class="quantidade-responsabilidade"></strong>
                    <br>
                    <small class="text-muted">Em posse</small>
                </div>
            </div>
            <div class="col-md-2">
                <input type="number" name="quantidades_devolver[]" class="form-control" min="0.01" step="0.01" disabled>
            </div>
            <div class="col-md-3">
                <div class="dias-responsabilidade"></div>
                <small class="data-retirada text-muted"></small>
            </div>
        </div>
        <div class="status-badge">
            <span class="status-responsabilidade"></span>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Carregar materiais do funcionário
    $('#funcionarioSelect').change(function() {
        const funcionarioId = $(this).val();
        const selectedOption = $(this).find(':selected');
        
        if (funcionarioId) {
            const nome = selectedOption.data('nome');
            const departamento = selectedOption.data('departamento');
            const materiais = selectedOption.data('materiais');
            
            $('#funcionarioNome').text(nome);
            $('#funcionarioDepartamento').text(departamento);
            $('#funcionarioMateriais').text(materiais);
            $('#funcionarioInfo').slideDown();
            
            // Carregar materiais via AJAX
            carregarMateriaisFuncionario(funcionarioId);
            
            $('#motivoSection, #observacoesSection, #botoesSection').slideDown();
        } else {
            $('#funcionarioInfo, #materiaisContainer, #motivoSection, #observacoesSection, #botoesSection').slideUp();
        }
    });

    function carregarMateriaisFuncionario(funcionarioId) {
        $.ajax({
            url: `/funcionarios/materiais/ajax/responsabilidades/${funcionarioId}/`,
            method: 'GET',
            success: function(data) {
                $('#materiaisList').empty();
                
                if (data.responsabilidades && data.responsabilidades.length > 0) {
                    data.responsabilidades.forEach(function(resp) {
                        const template = $('#materialItemTemplate').html();
                        const item = $(template);
                        
                        item.find('.material-checkbox').val(resp.id);
                        item.find('.produto-nome').text(resp.produto.nome);
                        item.find('.produto-codigo').text(resp.produto.codigo);
                        item.find('.quantidade-responsabilidade').text(resp.quantidade + ' ' + (resp.produto.unidade || 'UN'));
                        item.find('[name="quantidades_devolver[]"]').attr('max', resp.quantidade);
                        item.find('[name="quantidades_devolver[]"]').val(resp.quantidade);
                        item.find('.data-retirada').text('Retirado em: ' + resp.data_retirada_formatada);
                        
                        // Status baseado em dias
                        const diasPosse = resp.dias_posse;
                        let statusClass, statusText, badgeClass;
                        
                        if (diasPosse > 30) {
                            statusClass = 'text-danger';
                            statusText = `${diasPosse} dias`;
                            badgeClass = 'bg-danger';
                        } else if (diasPosse > 15) {
                            statusClass = 'text-warning';
                            statusText = `${diasPosse} dias`;
                            badgeClass = 'bg-warning';
                        } else {
                            statusClass = 'text-success';
                            statusText = `${diasPosse} dias`;
                            badgeClass = 'bg-success';
                        }
                        
                        item.find('.dias-responsabilidade').html(`<span class="${statusClass}">${statusText} em posse</span>`);
                        item.find('.status-responsabilidade').html(`<span class="badge ${badgeClass}">${resp.status}</span>`);
                        
                        $('#materiaisList').append(item);
                    });
                    
                    $('#materiaisContainer').slideDown();
                } else {
                    $('#materiaisList').html('<p class="text-muted text-center">Este funcionário não possui materiais sob responsabilidade.</p>');
                    $('#materiaisContainer').slideDown();
                }
            },
            error: function() {
                alert('Erro ao carregar materiais do funcionário.');
            }
        });
    }

    // Habilitar/desabilitar campo de quantidade
    $(document).on('change', '.material-checkbox', function() {
        const quantidadeInput = $(this).closest('.responsabilidade-item').find('[name="quantidades_devolver[]"]');
        
        if ($(this).is(':checked')) {
            quantidadeInput.prop('disabled', false).focus();
        } else {
            quantidadeInput.prop('disabled', true);
        }
    });

    // Validação do formulário
    $('#devolucaoForm').submit(function(e) {
        const materiaisSelecionados = $('.material-checkbox:checked');
        
        if (materiaisSelecionados.length === 0) {
            e.preventDefault();
            alert('Por favor, selecione pelo menos um material para devolução.');
            return;
        }

        // Validar quantidades
        let quantidadeValida = true;
        materiaisSelecionados.each(function() {
            const quantidade = $(this).closest('.responsabilidade-item').find('[name="quantidades_devolver[]"]').val();
            if (!quantidade || parseFloat(quantidade) <= 0) {
                quantidadeValida = false;
                return false;
            }
        });

        if (!quantidadeValida) {
            e.preventDefault();
            alert('Por favor, informe quantidades válidas para todos os materiais selecionados.');
            return;
        }

        // Confirmar devolução
        const confirmacao = confirm(`Confirma a devolução de ${materiaisSelecionados.length} material(is)?`);
        if (!confirmacao) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
