{% extends 'pandora_ultra_modern_base.html' %}
{% load i18n %}
{% block title %}Chat{% endblock %}
{% block page_header %}{% endblock %}
{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}
{% block extra_css %}
<style>
/* Layout principal estilo mensageiro */
#chat-workspace{height:calc(100vh - 190px);display:flex;gap:0.75rem;}
.pane{background:#ffffff;color:#212529;border:1px solid #e9ecef;border-radius:14px;display:flex;flex-direction:column;overflow:hidden;}
.pane.dark{background:#1e1f26;color:#fff;}
.pane-header{padding:.75rem 1rem;border-bottom:1px solid #e9ecef;display:flex;align-items:center;gap:.5rem;background:#ffffff;}
.pane-header.dark{background:#1e1f26;border-color:rgba(255,255,255,.07);} 
.search-box input{background:#f1f3f5;border:1px solid #dee2e6;color:#212529;}
.search-box input:focus{outline:none;box-shadow:0 0 0 2px #4e73df33;background:#fff;}
.list-scroll{flex:1;overflow-y:auto;}
.conv-item{padding:.65rem .9rem;cursor:pointer;display:flex;gap:.75rem;align-items:center;border-bottom:1px solid #f1f3f5;transition:background .12s, color .12s;}
.conv-item:hover{background:#f8f9fa;}
.conv-item.active{background:#4e73df;color:#fff;}
.avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#4e73df,#1cc88a);display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff;position:relative;}
.avatar.small{width:36px;height:36px;font-size:.8rem;}
.status-dot{position:absolute;bottom:2px;right:3px;width:11px;height:11px;border-radius:50%;background:#adb5bd;border:2px solid #1e1f26;}
.status-dot.online{background:#2ecc71;}
.msg-pane{flex:1;display:flex;flex-direction:column;background:#ffffff;border-radius:14px;overflow:hidden;}
.msg-header{padding:.9rem 1rem;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;}
#messages-area{flex:1;overflow-y:auto;padding:1rem;background:#f5f7fa;position:relative;}
.bubble{max-width:60%;padding:.6rem .9rem;border-radius:14px;margin-bottom:.65rem;position:relative;font-size:.9rem;line-height:1.3;word-break:break-word;background:#fff;border:1px solid #e3e6f0;}
.bubble.own{margin-left:auto;background:#4e73df;color:#fff;border-color:#4e73df;}
.bubble .meta{font-size:.65rem;opacity:.7;margin-top:.25rem;display:flex;align-items:center;gap:.35rem;}
.bubble .actions{position:absolute;top:4px;right:6px;display:flex;gap:4px;opacity:0;transition:opacity .15s;}
.bubble:hover .actions{opacity:1;}
.bubble .reacoes{margin-top:2px;display:flex;gap:4px;flex-wrap:wrap;}
#composer{padding:.75rem 1rem;border-top:1px solid #e9ecef;background:#fff;}
#composer form{display:flex;gap:.5rem;align-items:center;}
#btn-load-older{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:10;}
#composer input[type=text]{flex:1;}
.tag-badge{font-size:.55rem;letter-spacing:.5px;text-transform:uppercase;background:#212529;color:#fff;padding:2px 5px;border-radius:4px;}
.tag-badge.light{background:#4e73df;}
.empty-state{display:flex;align-items:center;justify-content:center;flex:1;flex-direction:column;color:#6c757d;}
.floating-indicator{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);background:#212529;color:#fff;font-size:.65rem;padding:4px 10px;border-radius:30px;opacity:.85;display:none;}
.bubble.editada:after{content:' (editada)';font-size:.65rem;opacity:.7;}
.conv-item .unread{background:#ffca2c;color:#212529;font-size:.65rem;font-weight:600;padding:2px 6px;border-radius:12px;margin-left:auto;}
.conv-item .time{font-size:.6rem;opacity:.6;margin-left:auto;}
.contact-section-title{padding:.4rem .9rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.7px;opacity:.6;}
.contact-item{padding:.55rem .9rem;display:flex;gap:.6rem;align-items:center;cursor:pointer;border-bottom:1px solid #f1f3f5;transition:background .12s;}
.contact-item:hover{background:#f1f5ff;}
.contact-item .start-btn{margin-left:auto;}
@media (max-width:1400px){#chat-workspace{height:calc(100vh - 210px);} .pane.contacts{display:none;} }
</style>
{% endblock %}
{% block content %}
<div class="container-fluid px-0 mb-3">
        <div class="row g-3">
            <div class="col-6 col-md-2">
                <a href="#" class="card stat-filter shadow-sm h-100 border-0 text-decoration-none" data-filter="unread">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small">Não Lidas</div>
                                <div class="h5 mb-0 fw-semibold" id="stat-unread">{{ unread_messages }}</div>
                            </div>
                            <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width:44px;height:44px;">
                                <i class="fas fa-envelope-open"></i>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-6 col-md-2">
                <a href="#" class="card stat-filter shadow-sm h-100 border-0 text-decoration-none" data-filter="all">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small">Conversas</div>
                                <div class="h5 mb-0 fw-semibold" id="stat-total">{{ total_conversas }}</div>
                            </div>
                            <div class="rounded-circle bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center" style="width:44px;height:44px;">
                                <i class="fas fa-comments"></i>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-6 col-md-2">
                <a href="#" class="card stat-filter shadow-sm h-100 border-0 text-decoration-none" data-filter="24h">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small">24h Mensagens</div>
                                <div class="h5 mb-0 fw-semibold">{{ mensagens_24h }}</div>
                            </div>
                            <div class="rounded-circle bg-info bg-opacity-10 text-info d-flex align-items-center justify-content-center" style="width:44px;height:44px;">
                                <i class="fas fa-history"></i>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-6 col-md-2">
                <a href="#" class="card stat-filter shadow-sm h-100 border-0 text-decoration-none" data-filter="favoritas">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small">Favoritas</div>
                                <div class="h5 mb-0 fw-semibold">{{ favoritas_count }}</div>
                            </div>
                            <div class="rounded-circle bg-warning bg-opacity-10 text-warning d-flex align-items-center justify-content-center" style="width:44px;height:44px;">
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-6 col-md-2">
                <a href="#" class="card stat-filter shadow-sm h-100 border-0 text-decoration-none" data-filter="fixadas">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small">Fixadas</div>
                                <div class="h5 mb-0 fw-semibold">{{ fixadas_count }}</div>
                            </div>
                            <div class="rounded-circle bg-secondary bg-opacity-10 text-secondary d-flex align-items-center justify-content-center" style="width:44px;height:44px;">
                                <i class="fas fa-thumbtack"></i>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-6 col-md-2">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small">Online</div>
                                <div class="h5 mb-0 fw-semibold" id="stat-online">0</div>
                            </div>
                            <div class="rounded-circle bg-danger bg-opacity-10 text-danger d-flex align-items-center justify-content-center" style="width:44px;height:44px;">
                                <i class="fas fa-signal"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>
<div id="chat-workspace" class="container-fluid p-0">
    <!-- Coluna Conversas -->
    <div class="pane" style="width:320px;min-width:280px;">
        <div class="pane-header">
            <div class="flex-grow-1 d-flex align-items-center gap-2">
                <i class="fas fa-comments text-primary"></i>
                <strong>Conversas</strong>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'chat:configuracao_chat' %}"><i class="fas fa-cog me-2"></i>Configurações</a></li>
                    <li><a class="dropdown-item" href="{% url 'chat:preferencia_usuario' %}"><i class="fas fa-sliders-h me-2"></i>Preferências</a></li>
                </ul>
            </div>
        </div>
        <div class="p-2 pt-3 border-bottom search-box">
            <input id="search-conv" type="text" class="form-control form-control-sm" placeholder="Buscar ou iniciar conversa...">
        </div>
        <div class="list-scroll" id="lista-conversas">
            {% for c in conversas %}
          <div class="conv-item{% if conversa_selecionada and conversa_selecionada.id == c.id %} active{% endif %}"
              data-conv-id="{{ c.id }}"
              data-last-activity="{% if c.ultima_atividade %}{{ c.ultima_atividade|date:'c' }}{% endif %}"
              {% if c.id in favoritas_ids %}data-favorita="1"{% endif %}
              {% if c.id in fixadas_conversas_ids %}data-fixada="1"{% endif %}>
                <div class="avatar small"><span>{{ c.get_titulo_display|default:c.id|slice:':2'|upper }}</span><span class="status-dot"></span></div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-semibold small">{{ c.get_titulo_display|default:'(Sem título)' }}</span>
                        {% if c.tipo == 'grupo' %}<span class="tag-badge">GRUPO</span>{% endif %}
                    </div>
                    <div class="small text-muted text-truncate" style="max-width:180px;">
                        {% with ultima=c.get_ultima_mensagem %}
                            {% if ultima %}{{ ultima.remetente.username }}: {{ ultima.conteudo|truncatechars:32 }}{% else %}<em>Sem mensagens</em>{% endif %}
                        {% endwith %}
                    </div>
                </div>
                <div class="text-end d-flex flex-column align-items-end" style="min-width:55px;">
                    <span class="time">{% if c.ultima_atividade %}{{ c.ultima_atividade|time:"H:i" }}{% endif %}</span>
                    {% if c.mensagens_nao_lidas %}<span class="unread" data-unread>{{ c.mensagens_nao_lidas }}</span>{% endif %}
                </div>
            </div>
            {% empty %}
            <div class="p-4 text-center text-muted small">Nenhuma conversa. Selecione um contato.</div>
            {% endfor %}
        </div>
    </div>
    <!-- Coluna Contatos -->
    <div class="pane light contacts" style="width:300px;min-width:260px;">
        <div class="pane-header light">
            <i class="fas fa-user-friends text-primary"></i>
            <strong>Contatos</strong>
        </div>
        <div class="p-2"><input id="search-contact" type="text" class="form-control form-control-sm" placeholder="Buscar contato..."></div>
        <div class="list-scroll" id="lista-contatos">
            <div class="contact-section-title">Disponíveis</div>
            {% for u in contatos %}
            <div class="contact-item" data-user-id="{{ u.id }}">
                <div class="avatar small"><span>{{ u.get_full_name|default:u.username|slice:':2'|upper }}</span><span class="status-dot"></span></div>
                <div class="flex-grow-1 small fw-semibold text-truncate">{{ u.get_full_name|default:u.username }}</div>
                <button class="btn btn-sm btn-outline-primary start-btn" title="Conversar"><i class="fas fa-arrow-right"></i></button>
            </div>
            {% empty %}
            <div class="p-4 text-center text-muted small">Nenhum contato.</div>
            {% endfor %}
        </div>
    </div>
    <!-- Painel Mensagens -->
    <div class="msg-pane" id="painel-mensagens" data-conv-current="{% if conversa_selecionada %}{{ conversa_selecionada.id }}{% endif %}">
        {% if not conversa_selecionada %}
        <div class="empty-state">
            <i class="fas fa-comments fa-3x opacity-25 mb-3"></i>
            <h5 class="mb-2">Selecione uma conversa ou contato</h5>
            <p class="small mb-0">Suas mensagens aparecerão aqui</p>
        </div>
        {% else %}
    <div class="msg-header">
            <div class="d-flex align-items-center gap-2">
                <div class="avatar small"><span>{{ conversa_selecionada.get_titulo_display|slice:':2'|upper }}</span><span class="status-dot" id="conv-status"></span></div>
                <div>
                    <div class="fw-semibold small">{{ conversa_selecionada.get_titulo_display }}</div>
                    <div class="text-muted small" id="typing-indicator"></div>
                </div>
            </div>
            <div class="d-flex gap-2">
        <button id="btn-toggle-fav" class="btn btn-outline-warning btn-sm" title="Favoritar"><i class="fas fa-star"></i></button>
        <a href="{% url 'chat:conversa_detail' conversa_selecionada.id %}" class="btn btn-outline-secondary btn-sm">Detalhes</a>
            </div>
        </div>
        <div id="messages-area"><button id="btn-load-older" class="btn btn-light btn-sm d-none">Carregar anteriores</button></div>
        <div id="composer">
            <form id="form-send">
                <label class="btn btn-outline-secondary btn-sm mb-0" title="Enviar arquivo">
                    <i class="fas fa-paperclip"></i>
                    <input type="file" id="file-input" hidden>
                </label>
                <input type="text" id="msg-input" class="form-control" autocomplete="off" placeholder="Mensagem...">
                <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
        {% endif %}
        <div class="floating-indicator" id="new-msg-indicator">Novas mensagens</div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
const wsScheme=location.protocol==='https:'?'wss':'ws';
let chatSocket=null;let overviewSocket=null;let currentConv=document.getElementById('painel-mensagens').dataset.convCurrent||null;let autoScroll=true;let typingTimeout=null;let globalOnline=[];const area=document.getElementById('messages-area');
// Conectar overview para presença global / unread
function connectOverview(){overviewSocket=new WebSocket(`${wsScheme}://${location.host}/ws/chat/overview/`);overviewSocket.onmessage=(e)=>{try{const d=JSON.parse(e.data);if(d.event==='presence_update'){globalOnline=d.online_user_ids||[];renderGlobalPresence();}else if(d.event==='snapshot'||d.event==='conversation_activity'){applyUnread(d.conversas||[]); if(d.online_user_ids){globalOnline=d.online_user_ids; renderGlobalPresence();}}}catch(err){console.warn(err)}}}
function applyUnread(items){items.forEach(it=>{const el=document.querySelector(`.conv-item[data-conv-id='${it.id}'] .unread`);if(el){if(it.unread>0){el.textContent=it.unread;}else{el.remove();}}else if(it.unread>0){const wrap=document.querySelector(`.conv-item[data-conv-id='${it.id}'] .text-end`);}}
}
function renderGlobalPresence(){document.querySelectorAll('.contact-item').forEach(ci=>{const uid=parseInt(ci.dataset.userId);const dot=ci.querySelector('.status-dot');if(!dot)return;dot.classList.toggle('online',globalOnline.includes(uid));});updateOnlineCard();}
function updateOnlineCard(){const el=document.getElementById('stat-online');if(el)el.textContent=globalOnline.length;}
function connectWS(){if(!currentConv)return; if(chatSocket){chatSocket.close();}
  chatSocket=new WebSocket(`${wsScheme}://${location.host}/ws/chat/conversa/${currentConv}/`);
    chatSocket.onmessage=(e)=>{try{const d=JSON.parse(e.data);switch(d.event){case 'new_message':appendBubble(d.mensagem,true);break;case 'typing':showTyping(d.username);break;case 'presence':updatePresence(d.online_user_ids||[]);globalOnline=d.online_user_ids||globalOnline;renderGlobalPresence();break;case 'message_edited':editBubble(d.mensagem);break;case 'message_deleted':deleteBubble(d.message_id);break;case 'message_status':updateStatus(d.message_id,d.status);break;case 'messages_status_bulk':d.message_ids.forEach(id=>updateStatus(id,d.status));break;case 'message_reactions':updateReacoes(d.message_id,d.reacoes);break;case 'message_pinned':togglePinned(d.message_id,d.fixada);break;} }catch(err){console.warn(err)}};
  chatSocket.onopen=()=>{loadMensagens(currentConv);} }
function appendBubble(m,auto){if(!area)return;const own=m.remetente_id===parseInt('{{ request.user.id }}');const b=document.createElement('div');b.className='bubble'+(own?' own':'')+(m.status==='editada'?' editada':'');b.dataset.id=m.id;let contentHtml=escapeHtml(m.conteudo);if(m.tipo==='imagem'&&m.arquivo_url){contentHtml=`<img src='${m.arquivo_url}' class='img-fluid rounded mb-1' style='max-height:240px; object-fit:cover;'>`+contentHtml;}else if(m.tipo==='arquivo'&&m.arquivo_url){contentHtml=`<a href='${m.arquivo_url}' target='_blank'><i class='fas fa-file-download me-1'></i>${m.arquivo_nome||m.conteudo}</a>`;}const statusIcon=own?statusIconHTML(m.status):'';const actions=`<div class='actions'>${own?"<button class='btn btn-xs btn-light py-0 px-1 edit-msg' title='Editar'><i class=\"fas fa-pen\"></i></button><button class='btn btn-xs btn-light py-0 px-1 del-msg' title='Excluir'><i class=\"fas fa-trash\"></i></button>":''}<button class='btn btn-xs btn-light py-0 px-1 react-msg' title='Reagir'><i class='fas fa-smile'></i></button><button class='btn btn-xs btn-light py-0 px-1 pin-msg' title='Fixar'><i class='fas fa-thumbtack'></i></button></div>`;b.innerHTML=`${actions}<div class='text'>${contentHtml}</div><div class='reacoes'></div><div class='meta'><span>${m.remetente}</span><span>${formatTime(m.created_at)}</span><span class='status-icon'>${statusIcon}</span></div>`;const atBottom=isAtBottom();area.appendChild(b);if(atBottom)scrollDown();else if(auto)showNewIndicator();if(m.reacoes)renderReacoes(b,m.reacoes);}
function renderReacoes(b,reacoes){const wrap=b.querySelector('.reacoes');wrap.innerHTML='';reacoes.forEach(r=>{const span=document.createElement('span');span.className='badge bg-light text-dark border';span.textContent=`${r.emoji} ${r.total}`;wrap.appendChild(span);});}
// Eventos de clique em ações de mensagens
area&&area.addEventListener('click',e=>{const bubble=e.target.closest('.bubble');if(!bubble)return;const id=bubble.dataset.id; if(e.target.closest('.react-msg')){const emoji=prompt('Emoji:'); if(!emoji)return; if(chatSocket&&chatSocket.readyState===1){chatSocket.send(JSON.stringify({action:'reaction',message_id:id,emoji:emoji}));} else {fetch('{% url 'chat:api_reagir_mensagem' %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},body:JSON.stringify({mensagem_id:id,emoji:emoji})}).then(r=>r.json()).then(d=>{if(d.status==='success'){renderReacoes(bubble,d.reacoes);}});} }
else if(e.target.closest('.pin-msg')){ if(chatSocket&&chatSocket.readyState===1){chatSocket.send(JSON.stringify({action:'pin',message_id:id}));} else {fetch('{% url 'chat:api_fixar_mensagem' %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},body:JSON.stringify({mensagem_id:id})}).then(r=>r.json()).then(d=>{if(d.status==='success'){bubble.classList.toggle('border-warning',d.fixada);}});} }
else if(e.target.closest('.del-msg')){if(confirm('Excluir mensagem?')){chatSocket&&chatSocket.send(JSON.stringify({action:'delete_message',message_id:id}));}}
else if(e.target.closest('.edit-msg')){const current=bubble.querySelector('.text').innerText;const novo=prompt('Editar mensagem:',current);if(novo&&novo.trim()){chatSocket&&chatSocket.send(JSON.stringify({action:'edit_message',message_id:id,conteudo:novo.trim()}));}}
});
// Favoritar conversa
document.getElementById('btn-toggle-fav')?.addEventListener('click',()=>{fetch('{% url 'chat:api_toggle_favorito' %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},body:JSON.stringify({conversa_id:currentConv})}).then(r=>r.json()).then(d=>{if(d.status==='success'){const ic=document.querySelector('#btn-toggle-fav i');ic.classList.toggle('text-warning',d.favorito); ic.classList.toggle('fas',true); ic.classList.toggle('far',!d.favorito);}});});
function statusIconHTML(st){if(st==='lida')return '<i class="fas fa-check-double text-primary"></i>'; if(st==='entregue')return '<i class="fas fa-check-double text-white-50"></i>'; return '<i class="fas fa-check text-white-50"></i>'}
function updateStatus(id,st){const b=document.querySelector(`.bubble[data-id='${id}']`);if(!b)return;const ic=b.querySelector('.status-icon');if(ic)ic.innerHTML=statusIconHTML(st);}
function updateReacoes(id,reac){const b=document.querySelector(`.bubble[data-id='${id}']`);if(!b)return;renderReacoes(b,reac);} 
function togglePinned(id,fix){const b=document.querySelector(`.bubble[data-id='${id}']`);if(!b)return; b.classList.toggle('border-warning',fix);} 
function isAtBottom(){return area.scrollHeight - area.scrollTop - area.clientHeight < 40;}
function scrollDown(){area.scrollTop=area.scrollHeight;}
function showNewIndicator(){const ind=document.getElementById('new-msg-indicator');ind.style.display='block';}
function hideNewIndicator(){document.getElementById('new-msg-indicator').style.display='none';}
function escapeHtml(t){const d=document.createElement('div');d.innerText=t;return d.innerHTML.replace(/\n/g,'<br>');}
function formatTime(ts){try{return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}catch{return ''}}
function showTyping(name){const el=document.getElementById('typing-indicator');if(!el)return;el.textContent=`${name} digitando...`;clearTimeout(typingTimeout);typingTimeout=setTimeout(()=>el.textContent='',1400);}
function updatePresence(ids){document.querySelectorAll('.conv-item').forEach(it=>{const avatar=it.querySelector('.avatar .status-dot');const cid=it.dataset.convId;if(!avatar)return;/* placeholder: poderia mapear ids p/ conversa */});}
function editBubble(m){const el=document.querySelector(`.bubble[data-id='${m.id}']`);if(!el)return;el.querySelector('.text').innerHTML=escapeHtml(m.conteudo);el.classList.add('editada');}
function deleteBubble(id){const el=document.querySelector(`.bubble[data-id='${id}']`);if(el){el.querySelector('.text').innerHTML='[Mensagem excluída]';el.classList.add('opacity-50');}}
let oldestId=null;function loadMensagens(conv){fetch(`{% url 'chat:api_conversa_mensagens' 0 %}`.replace('/0/','/'+conv+'/')).then(r=>r.json()).then(resp=>{if(resp.status==='success'){area.innerHTML='<button id="btn-load-older" class="btn btn-light btn-sm d-none">Carregar anteriores</button>';resp.mensagens.forEach(m=>appendBubble(m,false));if(resp.mensagens.length){oldestId=resp.mensagens[0].id;}toggleOlder(resp.has_more);scrollDown(); markAllRead();bindOlderButton();}})}
function loadOlder(){if(!oldestId)return;fetch(`{% url 'chat:api_conversa_mensagens' 0 %}`.replace('/0/','/'+currentConv+'/')+`?before_id=${oldestId}&limit=50`).then(r=>r.json()).then(resp=>{if(resp.status==='success'&&resp.mensagens.length){const prevHeight=area.scrollHeight;resp.mensagens.forEach(m=>{const own=m.remetente_id===parseInt('{{ request.user.id }}');const b=document.createElement('div');b.className='bubble'+(own?' own':'');b.dataset.id=m.id;let contentHtml=escapeHtml(m.conteudo);if(m.tipo==='imagem'&&m.arquivo_url){contentHtml=`<img src='${m.arquivo_url}' class='img-fluid rounded mb-1' style='max-height:240px;'>`+contentHtml;}else if(m.tipo==='arquivo'&&m.arquivo_url){contentHtml=`<a href='${m.arquivo_url}' target='_blank'><i class='fas fa-file-download me-1'></i>${m.arquivo_nome||m.conteudo}</a>`;}const statusIcon=own?statusIconHTML(m.status):'';b.innerHTML=`<div class='text'>${contentHtml}</div><div class='meta'><span>${m.remetente}</span><span>${formatTime(m.created_at)}</span><span class='status-icon'>${statusIcon}</span></div>`;area.insertBefore(b, area.firstChild.nextSibling);});oldestId=resp.mensagens[0].id;toggleOlder(resp.has_more);area.scrollTop=area.scrollHeight-prevHeight;} })}
function toggleOlder(show){const btn=document.getElementById('btn-load-older');if(!btn)return;btn.classList.toggle('d-none',!show);}function bindOlderButton(){const btn=document.getElementById('btn-load-older');if(btn&&!btn.dataset.bound){btn.dataset.bound='1';btn.addEventListener('click',loadOlder);}}
function markAllRead(){const ids=[...document.querySelectorAll('.bubble')].map(b=>parseInt(b.dataset.id));if(!ids.length||!chatSocket)return;chatSocket.send(JSON.stringify({action:'mark_read',message_ids:ids}));}
document.getElementById('lista-conversas').addEventListener('click',e=>{const item=e.target.closest('.conv-item');if(!item)return;document.querySelectorAll('.conv-item').forEach(i=>i.classList.remove('active'));item.classList.add('active');currentConv=item.dataset.convId;connectWS();});
const form=document.getElementById('form-send');if(form){form.addEventListener('submit',e=>{e.preventDefault();const input=document.getElementById('msg-input');const v=input.value.trim();if(!v||!chatSocket||chatSocket.readyState!==1)return;chatSocket.send(JSON.stringify({action:'send_message',conteudo:v}));input.value='';});document.getElementById('msg-input').addEventListener('input',()=>{if(chatSocket&&chatSocket.readyState===1)chatSocket.send(JSON.stringify({action:'typing'}));});}
area&&area.addEventListener('scroll',()=>{if(isAtBottom()){hideNewIndicator();autoScroll=true;}else{autoScroll=false;}});
document.getElementById('new-msg-indicator').addEventListener('click',()=>{scrollDown();hideNewIndicator();});
// Iniciar se já houver conversa
if(currentConv){connectWS();}
connectOverview();
// Filtros clicáveis nos cards
document.querySelectorAll('.stat-filter').forEach(card=>{card.addEventListener('click',e=>{e.preventDefault();const f=card.dataset.filter;filterConversas(f);});});
function filterConversas(tipo){const items=[...document.querySelectorAll('.conv-item')];items.forEach(it=>{it.style.display='';});const now=Date.now();if(tipo==='unread'){items.forEach(it=>{if(!it.querySelector('[data-unread]'))it.style.display='none';});}
else if(tipo==='favoritas'){items.forEach(it=>{if(!it.dataset.favorita)it.style.display='none';});}
else if(tipo==='fixadas'){items.forEach(it=>{if(!it.dataset.fixada)it.style.display='none';});}
else if(tipo==='24h'){const cutoff=now-24*3600*1000;items.forEach(it=>{const ts=Date.parse(it.dataset.lastActivity||'');if(!ts||ts<cutoff)it.style.display='none';});}
// 'all' mostra tudo
}
// Ping presença a cada 30s
setInterval(()=>{if(chatSocket&&chatSocket.readyState===1){chatSocket.send(JSON.stringify({action:'ping'}));}},30000);
// Start conversa ao clicar em contato
document.getElementById('lista-contatos').addEventListener('click',e=>{const btn=e.target.closest('.start-btn');if(!btn)return;const item=e.target.closest('.contact-item');const uid=item.dataset.userId;fetch('{% url 'chat:api_start_conversa' %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},body:JSON.stringify({user_id:uid})}).then(r=>r.json()).then(d=>{if(d.status==='success'){window.location='?c='+d.conversa_id;}});});
// Upload de arquivo
const fileInput=document.getElementById('file-input');if(fileInput){fileInput.addEventListener('change',()=>{if(!fileInput.files.length||!currentConv)return;const fd=new FormData();fd.append('file',fileInput.files[0]);fd.append('conversa_id',currentConv);fetch('{% url 'chat:api_upload_arquivo' %}',{method:'POST',headers:{'X-CSRFToken':'{{ csrf_token }}'},body:fd}).then(r=>r.json()).then(d=>{if(d.status!=='success'){alert('Falha upload: '+d.message);} fileInput.value='';});});}
</script>
{% endblock %}
