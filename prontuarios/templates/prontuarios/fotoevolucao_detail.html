{% extends "pandora_ultra_modern_base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-2 text-gray-800">Detalhes da Foto de Evolução</h1>
    <p class="mb-4">Informações detalhadas sobre a foto de evolução.</p>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Foto de Evolução para {{ fotoevolucao.cliente.nome_razao_social|default:fotoevolucao.cliente.nome_display }}</h6>
        </div>
        <div class="card-body">
            <p><strong>Cliente:</strong> {{ fotoevolucao.cliente.nome_razao_social|default:fotoevolucao.cliente.nome_display }}</p>
            <p><strong>Atendimento:</strong>
                {% if fotoevolucao.atendimento %}
                    {{ fotoevolucao.atendimento.servico.nome_servico }} - {{ fotoevolucao.atendimento.data_atendimento|date:"d/m/Y" }}
                {% else %}
                    —
                {% endif %}
            </p>
            <p><strong>Data da Foto:</strong> {{ fotoevolucao.data_foto|date:"d/m/Y H:i" }}</p>
            <p><strong>Tipo:</strong> {{ fotoevolucao.get_tipo_foto_display }}</p>
            <p><strong>Observações:</strong> {{ fotoevolucao.observacoes }}</p>
            {% if fotoevolucao.imagem %}
                <p><strong>Imagem:</strong></p>
                <img src="{{ fotoevolucao.imagem.url }}" class="img-fluid" alt="Foto de Evolução">
            {% else %}
                <p>Nenhuma imagem disponível.</p>
            {% endif %}
            <div class="mt-3">
                <strong>Derivados:</strong>
                {% if fotoevolucao.imagem_thumbnail %}<span class="badge bg-secondary">thumb</span>{% endif %}
                {% if fotoevolucao.imagem_webp %}<span class="badge bg-success">webp</span>{% endif %}
                {% if fotoevolucao.video_poster %}<span class="badge bg-dark">poster</span>{% endif %}
            </div>

            <a href="{% url 'prontuarios:fotos_evolucao_list' %}" class="btn btn-secondary">Voltar</a>
            <a href="{% url 'prontuarios:fotoevolucao_update' fotoevolucao.pk %}" class="btn btn-warning">Editar</a>
            <a href="{% url 'prontuarios:fotoevolucao_delete' fotoevolucao.pk %}" class="btn btn-danger">Excluir</a>
            <button type="button" id="btn-reprocessar" class="btn btn-outline-secondary">Reprocessar derivados</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
    function getCookie(name){
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');
    const btn = document.getElementById('btn-reprocessar');
    if(btn){
        btn.addEventListener('click', ()=>{
            btn.disabled=true; const old=btn.innerHTML; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>';
            fetch(`/prontuarios/api/fotos-evolucao/{{ fotoevolucao.id }}/reprocessar/`, {method:'POST', headers:{'X-CSRFToken': csrftoken}})
            .then(r=>r.json()).then(()=>{ alert('Reprocessamento agendado.'); })
            .catch(()=>{ alert('Falha ao agendar reprocessamento.'); })
            .finally(()=>{ btn.disabled=false; btn.innerHTML=old; });
        });
    }
})();
</script>
{% endblock %}


