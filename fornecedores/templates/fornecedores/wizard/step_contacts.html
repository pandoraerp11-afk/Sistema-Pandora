{% extends "pandora_wizard_form_ultra_modern.html" %}
{% load static %}
{% load widget_tweaks %}

{% block step_content %}
<!-- Contatos + Vendedores -->

<!-- Alerta Informativo -->
<div class="alert alert-info border-0 mb-4 wizard-alert">
  <div class="d-flex align-items-center">
    <i class="fas fa-address-book text-info me-3" style="font-size: 1.5rem;"></i>
    <div>
      <h6 class="mb-1 text-info">Contatos e Vendedores</h6>
      <small class="text-muted">Informe o contato principal e gerencie vendedores do fornecedor.</small>
    </div>
  </div>
  {% if form.additional_contacts_json %}
    {% render_field form.additional_contacts_json class+="wizard-additional-contacts-json" style="display:none" %}
  {% endif %}
  <input type="hidden" id="id_main-additional_contacts_json" name="main-additional_contacts_json" />
</div>

<!-- Contato Principal e Departamentais (aproveita campos do CORE) -->
<div class="wizard-section">
  <h5 class="wizard-section-title">
    <i class="fas fa-user-tie wizard-icon"></i>
    Contato Principal
  </h5>
  <div class="row g-2">
    {% include 'core/wizard/wizard_field.html' with field=form.nome_contato_principal field_size='md' hide_help_text=True %}
    {% include 'core/wizard/wizard_field.html' with field=form.cargo_contato_principal field_size='xs' %}
    {% include 'core/wizard/wizard_field.html' with field=form.telefone_contato_principal field_size='xs-auto' %}
    {% include 'core/wizard/wizard_field.html' with field=form.email_contato_principal field_size='grow' %}
  </div>
</div>

<div class="wizard-section">
  <h5 class="wizard-section-title">
    <i class="fas fa-building wizard-icon"></i>
    Contatos Departamentais (Opcional)
  </h5>
  <div class="row g-2">
    {% include 'core/wizard/wizard_field.html' with field=form.nome_responsavel_comercial field_size='md' %}
    {% include 'core/wizard/wizard_field.html' with field=form.cargo_responsavel_comercial field_size='xs' %}
    {% include 'core/wizard/wizard_field.html' with field=form.telefone_comercial field_size='xs-auto' hide_help_text=True %}
    {% include 'core/wizard/wizard_field.html' with field=form.email_comercial field_size='grow' hide_help_text=True %}
  </div>
  <div class="row g-2 mt-1">
    {% include 'core/wizard/wizard_field.html' with field=form.nome_responsavel_financeiro field_size='md' %}
    {% include 'core/wizard/wizard_field.html' with field=form.cargo_responsavel_financeiro field_size='xs' %}
    {% include 'core/wizard/wizard_field.html' with field=form.telefone_financeiro field_size='xs-auto' hide_help_text=True %}
    {% include 'core/wizard/wizard_field.html' with field=form.email_financeiro field_size='grow' hide_help_text=True %}
  </div>
</div>

<!-- Website e Redes Sociais (opcional) -->
<div class="wizard-section">
  <h5 class="wizard-section-title">
    <i class="fas fa-globe wizard-icon"></i>
    Website e Redes Sociais
  </h5>
  <div class="row">
    {% include 'core/wizard/wizard_field.html' with field=form.website %}
    {% include 'core/wizard/wizard_field.html' with field=form.linkedin %}
    {% include 'core/wizard/wizard_field.html' with field=form.instagram %}
    {% include 'core/wizard/wizard_field.html' with field=form.facebook %}
  </div>
</div>

<!-- Vendedores (dinâmico via modal, igual ao padrão de Endereços) -->
<div class="wizard-section">
  <div class="d-flex align-items-center justify-content-between">
    <h5 class="wizard-section-title mb-0">
      <i class="fas fa-user-tag wizard-icon"></i>
      Vendedores do Fornecedor
    </h5>
    <button type="button"
            class="btn btn-outline-primary btn-sm rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm"
            id="btnAddVendor"
            formnovalidate
            data-bs-toggle="tooltip"
            data-bs-placement="left"
            title="Adicionar vendedor"
            aria-label="Adicionar vendedor"
            style="width: 2rem; height: 2rem;">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- Campo oculto JSON -->
  {% if form.additional_vendors_json %}
    {% render_field form.additional_vendors_json class+="wizard-additional-vendors-json" style="display:none" %}
  {% endif %}

  <!-- Lista/Tabela de vendedores -->
  <div class="table-responsive mt-3">
    <table class="table table-sm align-middle mb-0" id="tblVendors">
      <colgroup>
        <col>
        <col style="width: 280px;">
        <col style="width: 120px;">
      </colgroup>
      <thead>
        <tr>
          <th>Nome</th>
          <th class="text-nowrap">Contatos</th>
          <th class="text-center text-nowrap">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <small class="text-muted d-block text-center mt-2">Adicione quantos vendedores forem necessários.</small>
  </div>
</div>

<!-- Funcionários (prestação de serviços) - dinâmico via modal, igual ao padrão de Endereços/Vendedores -->
<div class="wizard-section">
  <div class="d-flex align-items-center justify-content-between">
    <h5 class="wizard-section-title mb-0">
      <i class="fas fa-users-cog wizard-icon"></i>
      Funcionários do Fornecedor (Prestação de Serviços)
    </h5>
    <button type="button"
            class="btn btn-outline-primary btn-sm rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm"
            id="btnAddEmployee"
            formnovalidate
            data-bs-toggle="tooltip"
            data-bs-placement="left"
            title="Adicionar funcionário"
            aria-label="Adicionar funcionário"
            style="width: 2rem; height: 2rem;">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- Campo oculto JSON -->
  {% if form.additional_employees_json %}
    {% render_field form.additional_employees_json class+="wizard-additional-employees-json" style="display:none" %}
  {% endif %}

  <!-- Lista/Tabela de funcionários -->
  <div class="table-responsive mt-3">
    <table class="table table-sm align-middle mb-0" id="tblEmployees">
      <colgroup>
        <col>
        <col style="width: 180px;">{# Cargo #}
        <col style="width: 280px;">{# Contatos #}
        <col style="width: 120px;">{# Ações #}
      </colgroup>
      <thead>
        <tr>
          <th>Nome</th>
          <th class="text-nowrap">Cargo</th>
          <th class="text-nowrap">Contatos</th>
          <th class="text-center text-nowrap">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <small class="text-muted d-block text-center mt-2">Cadastre contatos de funcionários que prestam serviços (ex.: Técnico, Supervisor, Encarregado).</small>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Tooltips Bootstrap
  try { if (window.bootstrap && typeof bootstrap.Tooltip === 'function') {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
  } } catch(_) {}

  const jsonField = document.querySelector('.wizard-additional-vendors-json') || document.querySelector('input[name$="-additional_vendors_json"]');
  const tableBody = document.querySelector('#tblVendors tbody');
  const addBtn = document.getElementById('btnAddVendor');

  // Modal e fallback sem Bootstrap JS
  const modalEl = document.getElementById('modalAddVendor');
  const bsModal = window.bootstrap && modalEl ? new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true, focus: true }) : null;
  let manualBackdrop = null;
  let lastTrigger = null;

  function removeBackdrops(){
    try { document.querySelectorAll('.modal-backdrop').forEach(el => el.parentNode && el.parentNode.removeChild(el)); } catch(_) {}
    manualBackdrop = null;
  }
  function createBackdrop(){
    removeBackdrops();
    manualBackdrop = document.createElement('div');
    manualBackdrop.className = 'modal-backdrop fade show';
    manualBackdrop.addEventListener('click', () => closeModal());
    document.body.appendChild(manualBackdrop);
  }

  const btnSave = document.getElementById('btnSaveVendor');
  let editingIndex = null;
  const fld = {
    nome: document.getElementById('vendorNome'),
    telefone: document.getElementById('vendorTelefone'),
    email: document.getElementById('vendorEmail')
  };
  const errorBox = document.getElementById('vendorError');
  const modalTitle = document.getElementById('modalAddVendorLabel');
  let items = [];

  function setError(msg){
    if (!errorBox) return;
    if (!msg){ errorBox.classList.add('d-none'); errorBox.textContent=''; return; }
    errorBox.textContent = msg;
    errorBox.classList.remove('d-none');
  }
  function resetModal(){
    setError('');
    if (!fld.nome) return;
    fld.nome.value=''; fld.telefone.value=''; fld.email.value='';
  }
  function fillModal(it){ if (!it) return; fld.nome.value=it.nome||''; fld.telefone.value=it.telefone||''; fld.email.value=it.email||''; }
  function openModal(editIdx){
    try { lastTrigger = document.activeElement; } catch(_) { lastTrigger = null; }
    editingIndex = (typeof editIdx === 'number' && !isNaN(editIdx)) ? editIdx : null;
    if (editingIndex !== null) {
      setError(''); fillModal(items[editingIndex] || {});
      if (modalTitle) modalTitle.textContent = 'Editar Vendedor';
      if (btnSave) btnSave.textContent = 'Salvar';
    } else {
      resetModal();
      if (modalTitle) modalTitle.textContent = 'Adicionar Vendedor';
      if (btnSave) btnSave.textContent = 'Adicionar';
    }
    if (bsModal) bsModal.show();
    else if (modalEl){
      modalEl.classList.add('show'); modalEl.style.display='block'; modalEl.setAttribute('aria-modal','true'); modalEl.removeAttribute('aria-hidden'); document.body.classList.add('modal-open'); createBackdrop();
    }
  }
  function closeModal(){
    if (bsModal) bsModal.hide();
    else if (modalEl){
      try { const active=document.activeElement; if (active && modalEl.contains(active)) active.blur(); } catch(_) {}
      modalEl.classList.remove('show'); modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); modalEl.removeAttribute('aria-modal'); document.body.classList.remove('modal-open'); removeBackdrops();
    }
    try { if (lastTrigger && typeof lastTrigger.focus === 'function') lastTrigger.focus(); } catch(_) {}
    editingIndex = null; if (modalTitle) modalTitle.textContent='Adicionar Vendedor'; if (btnSave) btnSave.textContent='Adicionar';
  }
  document.addEventListener('keydown', function(ev){ if (!bsModal && ev.key === 'Escape') closeModal(); });
  if (modalEl && !bsModal) {
    const dismissBtns = modalEl.querySelectorAll('[data-bs-dismiss="modal"], [data-dismiss="modal"], .btn-close, .close');
    dismissBtns.forEach(btn => btn.addEventListener('click', function(){ closeModal(); }));
  }

  function loadFromField(){
    try { const raw = jsonField ? (jsonField.value || '[]') : '[]'; const parsed = JSON.parse(raw); items = Array.isArray(parsed) ? parsed : []; }
    catch(e){ items = []; }
  }
  function saveToField(){ if (jsonField) jsonField.value = JSON.stringify(items); }
  function renderTable(){
    if (!tableBody) return; tableBody.innerHTML='';
    if (!items.length){
      const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=3; td.className='text-muted text-center py-3'; td.textContent='Nenhum vendedor adicionado.'; tr.appendChild(td); tableBody.appendChild(tr); return;
    }
    items.forEach((it, idx) => {
      const tr=document.createElement('tr'); const tdNome=document.createElement('td'); const tdContato=document.createElement('td'); const tdAcoes=document.createElement('td');
      tdContato.className='text-nowrap'; tdAcoes.className='text-center text-nowrap';
      tdNome.textContent = it.nome || '-';
      const parts=[]; if (it.telefone) parts.push(it.telefone); if (it.email) parts.push(it.email); tdContato.textContent = parts.join(' • ');
      tdAcoes.innerHTML = `
        <div class="d-flex gap-2 justify-content-center">
          <button type="button" class="btn btn-sm btn-link text-primary p-0 btn-edit" data-idx="${idx}" title="Editar" aria-label="Editar"><i class="fas fa-pen"></i></button>
          <button type="button" class="btn btn-sm btn-link text-danger p-0 btn-remove" data-idx="${idx}" title="Remover" aria-label="Remover"><i class="fas fa-trash"></i></button>
        </div>`;
      tdAcoes.querySelector('.btn-edit').addEventListener('click', function(){ const i=parseInt(this.getAttribute('data-idx')); if (!isNaN(i)) openModal(i); });
      tdAcoes.querySelector('.btn-remove').addEventListener('click', function(){ const i=parseInt(this.getAttribute('data-idx')); if (!isNaN(i)) { items.splice(i,1); saveToField(); renderTable(); } });
      tr.appendChild(tdNome); tr.appendChild(tdContato); tr.appendChild(tdAcoes); tableBody.appendChild(tr);
    });
  }
  function collectFromModal(){
    const nome=(fld.nome?.value||'').trim(); const telefone=(fld.telefone?.value||'').trim(); const email=(fld.email?.value||'').trim();
    if (!nome){ setError('Informe o nome do vendedor.'); return null; }
    setError(''); return { nome, telefone, email };
  }
  if (addBtn) addBtn.addEventListener('click', function(e){ e.preventDefault(); openModal(null); });
  if (btnSave) btnSave.addEventListener('click', function(){ const novo=collectFromModal(); if (!novo) return; if (editingIndex!==null){ items[editingIndex]=novo; } else { items.push(novo); } saveToField(); renderTable(); closeModal(); });

  if (jsonField){ loadFromField(); renderTable(); }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Tooltips
  try { if (window.bootstrap && typeof bootstrap.Tooltip === 'function') {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
  } } catch(_) {}

  const jsonField = document.querySelector('.wizard-additional-employees-json') || document.querySelector('input[name$="-additional_employees_json"]');
  const tableBody = document.querySelector('#tblEmployees tbody');
  const addBtn = document.getElementById('btnAddEmployee');

  const modalEl = document.getElementById('modalAddEmployee');
  const bsModal = window.bootstrap && modalEl ? new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true, focus: true }) : null;
  let lastTrigger = null;

  const btnSave = document.getElementById('btnSaveEmployee');
  let editingIndex = null;
  const fld = {
    nome: document.getElementById('employeeNome'),
    cargo: document.getElementById('employeeCargo'),
    telefone: document.getElementById('employeeTelefone'),
    email: document.getElementById('employeeEmail')
  };
  const errorBox = document.getElementById('employeeError');
  const modalTitle = document.getElementById('modalAddEmployeeLabel');
  let items = [];

  function setError(msg){ if (!errorBox) return; if (!msg){ errorBox.classList.add('d-none'); errorBox.textContent=''; return; } errorBox.textContent = msg; errorBox.classList.remove('d-none'); }
  function resetModal(){ setError(''); if (!fld.nome) return; fld.nome.value=''; fld.cargo.value=''; fld.telefone.value=''; fld.email.value=''; }
  function fillModal(it){ if (!it) return; fld.nome.value=it.nome||''; fld.cargo.value=it.cargo||''; fld.telefone.value=it.telefone||''; fld.email.value=it.email||''; }
  function openModal(editIdx){ try { lastTrigger=document.activeElement; } catch(_) { lastTrigger=null; } editingIndex=(typeof editIdx==='number'&&!isNaN(editIdx))?editIdx:null; if(editingIndex!==null){ setError(''); fillModal(items[editingIndex]||{}); if(modalTitle) modalTitle.textContent='Editar Funcionário'; if(btnSave) btnSave.textContent='Salvar'; } else { resetModal(); if(modalTitle) modalTitle.textContent='Adicionar Funcionário'; if(btnSave) btnSave.textContent='Adicionar'; } if (bsModal) bsModal.show(); else if (modalEl){ modalEl.classList.add('show'); modalEl.style.display='block'; modalEl.setAttribute('aria-modal','true'); modalEl.removeAttribute('aria-hidden'); document.body.classList.add('modal-open'); }
  }
  function closeModal(){ if (bsModal) bsModal.hide(); else if (modalEl){ try{ const active=document.activeElement; if(active && modalEl.contains(active)) active.blur(); }catch(_){} modalEl.classList.remove('show'); modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); modalEl.removeAttribute('aria-modal'); document.body.classList.remove('modal-open'); } try { if(lastTrigger && typeof lastTrigger.focus==='function') lastTrigger.focus(); } catch(_) {} editingIndex=null; if(modalTitle) modalTitle.textContent='Adicionar Funcionário'; if(btnSave) btnSave.textContent='Adicionar'; }
  if (modalEl && !bsModal) { const dismissBtns = modalEl.querySelectorAll('[data-bs-dismiss="modal"], [data-dismiss="modal"], .btn-close, .close'); dismissBtns.forEach(btn => btn.addEventListener('click', function(){ closeModal(); })); }

  function loadFromField(){ try { const raw=jsonField ? (jsonField.value||'[]') : '[]'; const parsed=JSON.parse(raw); items = Array.isArray(parsed) ? parsed : []; } catch(_) { items=[]; } }
  function saveToField(){ if (jsonField) jsonField.value = JSON.stringify(items); }
  function renderTable(){ if (!tableBody) return; tableBody.innerHTML=''; if (!items.length){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=4; td.className='text-muted text-center py-3'; td.textContent='Nenhum funcionário adicionado.'; tr.appendChild(td); tableBody.appendChild(tr); return; } items.forEach((it, idx) => { const tr=document.createElement('tr'); const tdNome=document.createElement('td'); const tdCargo=document.createElement('td'); const tdContato=document.createElement('td'); const tdAcoes=document.createElement('td'); tdCargo.className='text-nowrap'; tdContato.className='text-nowrap'; tdAcoes.className='text-center text-nowrap'; tdNome.textContent = it.nome || '-'; tdCargo.textContent = it.cargo || '-'; const parts=[]; if (it.telefone) parts.push(it.telefone); if (it.email) parts.push(it.email); tdContato.textContent = parts.join(' • '); tdAcoes.innerHTML = `<div class="d-flex gap-2 justify-content-center"><button type="button" class="btn btn-sm btn-link text-primary p-0 btn-edit" data-idx="${idx}" title="Editar" aria-label="Editar"><i class="fas fa-pen"></i></button><button type="button" class="btn btn-sm btn-link text-danger p-0 btn-remove" data-idx="${idx}" title="Remover" aria-label="Remover"><i class="fas fa-trash"></i></button></div>`; tdAcoes.querySelector('.btn-edit').addEventListener('click', function(){ const i=parseInt(this.getAttribute('data-idx')); if(!isNaN(i)) openModal(i); }); tdAcoes.querySelector('.btn-remove').addEventListener('click', function(){ const i=parseInt(this.getAttribute('data-idx')); if(!isNaN(i)) { items.splice(i,1); saveToField(); renderTable(); } }); tr.appendChild(tdNome); tr.appendChild(tdCargo); tr.appendChild(tdContato); tr.appendChild(tdAcoes); tableBody.appendChild(tr); }); }
  function collectFromModal(){ const nome=(fld.nome?.value||'').trim(); const cargo=(fld.cargo?.value||'').trim(); const telefone=(fld.telefone?.value||'').trim(); const email=(fld.email?.value||'').trim(); if (!nome){ setError('Informe o nome do funcionário.'); return null; } if (!cargo){ setError('Informe o cargo.'); return null; } setError(''); return { nome, cargo, telefone, email }; }
  if (addBtn) addBtn.addEventListener('click', function(e){ e.preventDefault(); openModal(null); });
  if (btnSave) btnSave.addEventListener('click', function(){ const novo=collectFromModal(); if(!novo) return; if (editingIndex!==null){ items[editingIndex]=novo; } else { items.push(novo); } saveToField(); renderTable(); closeModal(); });

  if (jsonField){ loadFromField(); renderTable(); }
});
</script>
{% endblock %}

{% block modals %}
<div class="modal fade" id="modalAddVendor" tabindex="-1" aria-labelledby="modalAddVendorLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAddVendorLabel">Adicionar Vendedor</h5>
        <button type="button" class="btn-close close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"><span class="d-none" aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <div id="vendorError" class="alert alert-danger py-2 px-3 d-none mb-3"></div>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label" for="vendorNome">Nome</label>
            <input id="vendorNome" type="text" class="form-control form-control-sm" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="vendorTelefone">Telefone</label>
            <input id="vendorTelefone" type="text" class="form-control form-control-sm" />
          </div>
          <div class="col-12">
            <label class="form-label" for="vendorEmail">E-mail</label>
            <input id="vendorEmail" type="email" class="form-control form-control-sm" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnSaveVendor">Adicionar</button>
      </div>
    </div>
  </div>
  </div>

<div class="modal fade" id="modalAddEmployee" tabindex="-1" aria-labelledby="modalAddEmployeeLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAddEmployeeLabel">Adicionar Funcionário</h5>
        <button type="button" class="btn-close close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"><span class="d-none" aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <div id="employeeError" class="alert alert-danger py-2 px-3 d-none mb-3"></div>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label" for="employeeNome">Nome</label>
            <input id="employeeNome" type="text" class="form-control form-control-sm" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="employeeCargo">Cargo</label>
            <input id="employeeCargo" type="text" class="form-control form-control-sm" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="employeeTelefone">Telefone</label>
            <input id="employeeTelefone" type="text" class="form-control form-control-sm" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="employeeEmail">E-mail</label>
            <input id="employeeEmail" type="email" class="form-control form-control-sm" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnSaveEmployee">Adicionar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
