{% extends "pandora_wizard_form_ultra_modern.html" %}
{% load widget_tweaks %}

{% block step_content %}
<div class="alert alert-info border-0 mb-4 wizard-alert">
  <div class="d-flex align-items-center">
    <i class="fas fa-gear text-info me-3" style="font-size: 1.5rem;"></i>
    <div>
      <h6 class="mb-1 text-info">Configurações do Fornecedor</h6>
      <small class="text-muted">Defina preferências gerais e o tipo de fornecimento.</small>
    </div>
  </div>
</div>

<div class="wizard-section">
  <h5 class="wizard-section-title mb-0"><i class="fas fa-boxes-stacked wizard-icon"></i> Tipo de Fornecimento</h5>
  <div class="row g-2">
    {% include 'core/wizard/wizard_field.html' with field=form.tipo_fornecimento field_size='sm' %}
  </div>
</div>

<div class="wizard-section mt-4">
  <h5 class="wizard-section-title"><i class="fas fa-clock wizard-icon"></i> Condições Comerciais</h5>
  <div class="row g-3 align-items-end">
    <div class="col-md-4 col-lg-4">{% include 'core/wizard/wizard_field.html' with field=form.prazo_medio_entrega_dias field_size='md' %}</div>
    <div class="col-md-4 col-lg-4">{% include 'core/wizard/wizard_field.html' with field=form.prazo_pagamento_dias field_size='md' %}</div>
    <div class="col-md-4 col-lg-4">{% include 'core/wizard/wizard_field.html' with field=form.pedido_minimo field_size='md' %}</div>
  </div>
</div>

<div class="wizard-section mt-4">
  <div class="d-flex align-items-center justify-content-between">
    <h5 class="wizard-section-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Cadastre uma ou mais contas clicando no botão (+) e gerencie-as na tabela abaixo.">
      <i class="fas fa-university wizard-icon"></i>
      Dados Bancários
    </h5>
    <button type="button"
            class="btn btn-outline-primary btn-sm rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm"
            id="btnAddBankAccount"
            formnovalidate
            data-bs-toggle="tooltip"
            data-bs-placement="left"
            title="Adicionar conta bancária"
            aria-label="Adicionar conta bancária"
            style="width: 2rem; height: 2rem;">
      <i class="fas fa-plus"></i>
    </button>
  </div>
  <!-- Texto explicativo movido para tooltip do título -->

  <!-- (Conta principal removida conforme solicitação) -->

  <!-- Campo oculto JSON -->
  <input type="hidden" id="id_main-additional_bank_json" name="main-additional_bank_json" />

  <!-- Lista de Contas Adicionais -->
  <div class="table-responsive mt-4">
    <table class="table table-sm align-middle mb-0" id="tblBankAccounts">
      <colgroup>
        <col>
        <col style="width: 140px;">
        <col style="width: 160px;">
        <col style="width: 200px;">
        <col style="width: 120px;">
      </colgroup>
      <thead>
        <tr>
          <th>Banco</th>
          <th class="text-nowrap">Agência</th>
          <th class="text-nowrap">Conta</th>
            <th class="text-nowrap">Chave PIX</th>
          <th class="text-center text-nowrap">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <small class="text-muted d-block text-center mt-2">Cadastre contas adicionais se este fornecedor possuir múltiplas contas para recebimento.</small>
  </div>
</div>

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Tooltips
  try { if (window.bootstrap && typeof bootstrap.Tooltip === 'function') {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
  } } catch(_) {}

  const jsonField = document.getElementById('id_main-additional_bank_json');
  const tableBody = document.querySelector('#tblBankAccounts tbody');
  const addBtn = document.getElementById('btnAddBankAccount');

  const modalEl = document.getElementById('modalAddBankAccount');
  const bsModal = window.bootstrap && modalEl ? new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true, focus: true }) : null;
  let lastTrigger = null;

  const btnSave = document.getElementById('btnSaveBankAccount');
  let editingIndex = null;
  const fld = {
    banco: document.getElementById('bankNome'),
    agencia: document.getElementById('bankAgencia'),
    conta: document.getElementById('bankConta'),
    chave_pix: document.getElementById('bankPix')
  };
  const errorBox = document.getElementById('bankError');
  const modalTitle = document.getElementById('modalAddBankAccountLabel');
  let items = [];

  function setError(msg){ if (!errorBox) return; if (!msg){ errorBox.classList.add('d-none'); errorBox.textContent=''; return; } errorBox.textContent = msg; errorBox.classList.remove('d-none'); }
  function resetModal(){ setError(''); if (!fld.banco) return; Object.values(fld).forEach(i=>{ if(i) i.value=''; }); }
  function fillModal(it){ if (!it) return; Object.entries(fld).forEach(([k,input])=>{ if(input) input.value = it[k] || ''; }); }
  function openModal(editIdx){ try { lastTrigger=document.activeElement; } catch(_) { lastTrigger=null; } editingIndex=(typeof editIdx==='number'&&!isNaN(editIdx))?editIdx:null; if(editingIndex!==null){ setError(''); fillModal(items[editingIndex]||{}); if(modalTitle) modalTitle.textContent='Editar Conta'; if(btnSave) btnSave.textContent='Salvar'; } else { resetModal(); if(modalTitle) modalTitle.textContent='Adicionar Conta'; if(btnSave) btnSave.textContent='Adicionar'; } if (bsModal) bsModal.show(); else if (modalEl){ modalEl.classList.add('show'); modalEl.style.display='block'; modalEl.setAttribute('aria-modal','true'); modalEl.removeAttribute('aria-hidden'); document.body.classList.add('modal-open'); }
  }
  function closeModal(){ if (bsModal) bsModal.hide(); else if (modalEl){ try{ const active=document.activeElement; if(active && modalEl.contains(active)) active.blur(); }catch(_){} modalEl.classList.remove('show'); modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); modalEl.removeAttribute('aria-modal'); document.body.classList.remove('modal-open'); } try { if(lastTrigger && typeof lastTrigger.focus==='function') lastTrigger.focus(); } catch(_) {} editingIndex=null; if(modalTitle) modalTitle.textContent='Adicionar Conta'; if(btnSave) btnSave.textContent='Adicionar'; }
  if (modalEl && !bsModal) { const dismissBtns = modalEl.querySelectorAll('[data-bs-dismiss="modal"], [data-dismiss="modal"], .btn-close, .close'); dismissBtns.forEach(btn => btn.addEventListener('click', function(){ closeModal(); })); }

  function loadFromField(){ try { const raw=jsonField ? (jsonField.value||'[]') : '[]'; const parsed=JSON.parse(raw); items = Array.isArray(parsed) ? parsed : []; } catch(_) { items=[]; } }
  function saveToField(){ if (jsonField) jsonField.value = JSON.stringify(items); }
  function renderTable(){ if (!tableBody) return; tableBody.innerHTML=''; if (!items.length){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.className='text-muted text-center py-3'; td.textContent='Nenhuma conta adicional cadastrada.'; tr.appendChild(td); tableBody.appendChild(tr); return; } items.forEach((it, idx) => { const tr=document.createElement('tr'); const tdBanco=document.createElement('td'); const tdAgencia=document.createElement('td'); const tdConta=document.createElement('td'); const tdPix=document.createElement('td'); const tdAcoes=document.createElement('td'); tdAgencia.className='text-nowrap'; tdConta.className='text-nowrap'; tdPix.className='text-nowrap'; tdAcoes.className='text-center text-nowrap'; tdBanco.textContent = it.banco || '-'; tdAgencia.textContent = it.agencia || '-'; tdConta.textContent = it.conta || '-'; tdPix.textContent = it.chave_pix || '-'; tdAcoes.innerHTML = `<div class="d-flex gap-2 justify-content-center"><button type="button" class="btn btn-sm btn-link text-primary p-0 btn-edit" data-idx="${idx}" title="Editar" aria-label="Editar"><i class="fas fa-pen"></i></button><button type="button" class="btn btn-sm btn-link text-danger p-0 btn-remove" data-idx="${idx}" title="Remover" aria-label="Remover"><i class="fas fa-trash"></i></button></div>`; tdAcoes.querySelector('.btn-edit').addEventListener('click', function(){ const i=parseInt(this.getAttribute('data-idx')); if(!isNaN(i)) openModal(i); }); tdAcoes.querySelector('.btn-remove').addEventListener('click', function(){ const i=parseInt(this.getAttribute('data-idx')); if(!isNaN(i)) { items.splice(i,1); saveToField(); renderTable(); } }); tr.appendChild(tdBanco); tr.appendChild(tdAgencia); tr.appendChild(tdConta); tr.appendChild(tdPix); tr.appendChild(tdAcoes); tableBody.appendChild(tr); }); }
  function collectFromModal(){ const banco=(fld.banco?.value||'').trim(); const agencia=(fld.agencia?.value||'').trim(); const conta=(fld.conta?.value||'').trim(); const chave_pix=(fld.chave_pix?.value||'').trim(); if(!banco){ setError('Informe o banco.'); return null; } if(!conta){ setError('Informe a conta.'); return null; } setError(''); return { banco, agencia, conta, chave_pix }; }
  if (addBtn) addBtn.addEventListener('click', function(e){ e.preventDefault(); openModal(null); });
  if (btnSave) btnSave.addEventListener('click', function(){ const novo=collectFromModal(); if(!novo) return; if (editingIndex!==null){ items[editingIndex]=novo; } else { items.push(novo); } saveToField(); renderTable(); closeModal(); });

  if (jsonField){ loadFromField(); renderTable(); }
});
</script>
{% endblock %}

{% block modals %}
{{ block.super }}
<div class="modal fade" id="modalAddBankAccount" tabindex="-1" aria-labelledby="modalAddBankAccountLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAddBankAccountLabel">Adicionar Conta</h5>
        <button type="button" class="btn-close close" data-bs-dismiss="modal" data-dismiss="modal" aria-label="Close"><span class="d-none" aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        <div id="bankError" class="alert alert-danger py-2 px-3 d-none mb-3"></div>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label" for="bankNome">Banco</label>
            <input id="bankNome" type="text" class="form-control form-control-sm" maxlength="100" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="bankAgencia">Agência</label>
            <input id="bankAgencia" type="text" class="form-control form-control-sm" maxlength="20" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="bankConta">Conta</label>
            <input id="bankConta" type="text" class="form-control form-control-sm" maxlength="20" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="bankPix">Chave PIX</label>
            <input id="bankPix" type="text" class="form-control form-control-sm" maxlength="255" />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnSaveBankAccount">Adicionar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% endblock %}
