{% extends "pandora_ultra_modern_base.html" %}
{% load static agendamento_extras %}
{% block title %}{% if agendamento %}Editar Agendamento{% else %}Novo Agendamento{% endif %}{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-semibold mb-0"><i class="fas fa-{{ agendamento|yesno:'edit,plus' }} me-2 text-primary"></i>{% if agendamento %}Editar Agendamento #{{ agendamento.id }}{% else %}Novo Agendamento{% endif %}</h2>
    <a href="{% url 'agendamentos:agendamento-list' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i></a>
  </div>
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="alert alert-danger py-1 small">{{ form.non_field_errors }}</div>
        {% endif %}
        <div class="row g-4">
          <div class="col-md-6">
            <fieldset class="border rounded p-3 h-100">
              <legend class="float-none w-auto px-2 small text-muted">Básico</legend>
              {% for name in basic_fields %}
                {% with field=form|get_field:name %}
                  {% if field %}
                  <div class="mb-2">
                    <label class="form-label small fw-semibold">{{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}</label>
                    {{ field|add_class:'form-control form-control-sm' }}
                    {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                  </div>
                  {% endif %}
                {% endwith %}
              {% endfor %}
            </fieldset>
          </div>
          <div class="col-md-6">
            <fieldset class="border rounded p-3 h-100">
              <legend class="float-none w-auto px-2 small text-muted">Tempo & Slot</legend>
              {% for name in time_fields %}
                {% with field=form|get_field:name %}
                  {% if field %}
                  <div class="mb-2">
                    <label class="form-label small fw-semibold">{{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}</label>
                    {{ field|add_class:'form-control form-control-sm' }}
                    {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                  </div>
                  {% endif %}
                {% endwith %}
              {% endfor %}
            </fieldset>
          </div>
          <div class="col-md-6">
            <fieldset class="border rounded p-3 h-100">
              <legend class="float-none w-auto px-2 small text-muted">Serviço</legend>
              {% with field=form.servico %}
              <div class="mb-2">
                <label class="form-label small fw-semibold">{{ field.label }} <span class="badge bg-secondary" id="servico-required-flag" style="display:none;">Obrigatório</span></label>
                {{ field|add_class:'form-select form-select-sm' }}
                {% for e in field.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </div>
              {% endwith %}
              <small class="text-muted d-block">Se definido, duração e pendências clínicas serão aplicadas automaticamente.</small>
            </fieldset>
          </div>
        </div>
        <div class="mt-3 d-flex justify-content-end">
          <button class="btn btn-primary btn-sm"><i class="fas fa-save me-1"></i>Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
 (function(){
   // Exibir badge obrigatório se flag global estiver ativa (exposta via meta tag opcional)
   try {
     const required = {{ REQUIRE_SERVICO|default:'false'|lower }};
     if(required){
       const badge = document.getElementById('servico-required-flag');
       if(badge) badge.style.display='inline-block';
     }
   } catch(e) {}
 })();
</script>
{% endblock %}
