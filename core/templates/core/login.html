{% load static %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Pandora ERP – Login</title>
    <meta name="theme-color" content="#0d47a1" />
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'dist/img/favicon/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'dist/img/favicon/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'dist/img/favicon/favicon-16x16.png' %}">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link href="{% static 'dist/css/pandora-ultra-modern.css' %}" rel="stylesheet">

    <style>
        :root {
            --pandora-primary: #1d4ed8;
            --pandora-primary-accent: #2563eb;
            --pandora-bg-dark: #0f172a;
            --pandora-bg-darker: #0b1322;
            --pandora-surface: #ffffff;
            --pandora-surface-alt: #f1f5f9;
            --pandora-border: rgba(255,255,255,0.08);
        }
        [data-theme="dark"] {
            --pandora-surface: #0f172a;
            --pandora-surface-alt: #162132;
            --pandora-border: rgba(255,255,255,0.12);
            color-scheme: dark;
        }
        html, body { height:100%; }
        body.login-body { font-family: 'Inter', system-ui, Arial, sans-serif; background:#0d47a1; }
        .login-left { position:relative; background:linear-gradient(145deg,#0d47a1 0%,#1e3a8a 45%,#2563eb 100%); color:#fff; overflow:hidden; }
        .login-left:before, .login-left:after { content:""; position:absolute; inset:0; background-image:radial-gradient(circle at 25% 15%,rgba(255,255,255,0.12),transparent 60%),radial-gradient(circle at 80% 70%,rgba(255,255,255,0.10),transparent 65%); mix-blend-mode:overlay; animation:bgfade 9s ease-in-out infinite alternate; }
        @keyframes bgfade { to { transform:scale(1.03); opacity:0.85; } }
        .login-left-content { position:relative; z-index:2; padding:4rem 4rem 3rem; max-width:540px; }
        .login-logo h1 { letter-spacing:-1px; }
        .feature-item { display:flex; gap:1rem; padding:1rem 1.15rem; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); border-radius:18px; backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px); margin-bottom:1.1rem; position:relative; overflow:hidden; }
        .feature-item:before { content:""; position:absolute; inset:0; background:linear-gradient(135deg,rgba(255,255,255,0.18),rgba(255,255,255,0)); opacity:0; transition:opacity .5s; }
        .feature-item:hover:before { opacity:1; }
        .feature-icon { width:48px; height:48px; background:linear-gradient(135deg,var(--pandora-primary-accent),#1d4ed8); color:#fff; display:flex; align-items:center; justify-content:center; border-radius:14px; font-size:1.3rem; box-shadow:0 6px 18px -6px rgba(0,0,0,0.45),0 2px 6px -2px rgba(0,0,0,0.4); }
        .feature-content h5 { margin:0 0 .25rem; font-weight:600; }

        .login-right { background:var(--pandora-surface); display:flex; align-items:center; justify-content:center; padding:3rem 2rem; position:relative; }
        [data-theme="dark"] .login-right { background:var(--pandora-bg-dark); }
        .login-form-container { width:100%; max-width:420px; background:var(--pandora-surface); border-radius:28px; padding:2.2rem 2.1rem 2rem; box-shadow:0 10px 30px -12px rgba(0,0,0,0.18),0 6px 14px -8px rgba(0,0,0,0.16); border: 1px solid rgba(0,0,0,0.04); }
        [data-theme="dark"] .login-form-container { background:var(--pandora-surface-alt); border-color:var(--pandora-border); }
        .login-form-header h2 { font-weight:700; }
        .messages-container { position:relative; }
        .messages-container .alert { border-radius:14px; font-size:.875rem; padding:.85rem 1rem; display:flex; align-items:flex-start; gap:.55rem; }
        .login-form .form-label { font-weight:600; font-size:.85rem; text-transform:uppercase; letter-spacing:.5px; }
        .input-group-text { background:var(--pandora-surface-alt); border:1px solid #d9e2f0; }
        [data-theme="dark"] .input-group-text { background:#1e293b; border-color:#2c3a52; }
        .form-control { padding:.85rem .95rem; border-radius:14px; }
        .form-control:focus { box-shadow:0 0 0 3px rgba(37,99,235,.25); }
        [data-theme="dark"] .form-control { background:#1e293b; color:#f1f5f9; border-color:#324258; }
        .btn-primary { background:var(--pandora-primary); border-radius:16px; font-weight:600; letter-spacing:.4px; padding:.95rem 1.2rem; display:flex; align-items:center; justify-content:center; gap:.45rem; }
        .btn-primary:hover { background:var(--pandora-primary-accent); }
        .btn-social { position:relative; border-radius:14px; background:#ffffff; border:1px solid #dbe3ef; color:#334155; font-weight:500; display:flex; align-items:center; justify-content:center; gap:.6rem; }
        .btn-social:hover { background:#f1f5f9; }
        [data-theme="dark"] .btn-social { background:#1e293b; border-color:#334155; color:#e2e8f0; }
        [data-theme="dark"] .btn-social:hover { background:#273548; }
        .social-login-divider { position:relative; text-align:center; }
        .social-login-divider:before { content:""; position:absolute; top:50%; left:0; right:0; height:1px; background:linear-gradient(90deg,transparent,#cbd5e1,transparent); }
        [data-theme="dark"] .social-login-divider:before { background:linear-gradient(90deg,transparent,#475569,transparent); }
        .social-login-divider span { background:var(--pandora-surface); padding:0 .75rem; position:relative; z-index:1; font-size:.7rem; font-weight:600; letter-spacing:1px; color:#64748b; }
        [data-theme="dark"] .social-login-divider span { background:var(--pandora-surface-alt); color:#94a3b8; }
        .login-footer { font-size:.7rem; color:#64748b; }
        [data-theme="dark"] .login-footer { color:#94a3b8; }
        .toggle-theme-btn { position:absolute; top:1rem; right:1rem; border:none; background:rgba(255,255,255,0.1); color:#fff; padding:.55rem .8rem; border-radius:14px; font-size:.9rem; display:flex; gap:.45rem; align-items:center; cursor:pointer; backdrop-filter:blur(6px); }
        .toggle-theme-btn:hover { background:rgba(255,255,255,0.18); }
        [data-theme="dark"] .toggle-theme-btn { background:#1e293b; color:#e2e8f0; }
        [data-theme="dark"] .toggle-theme-btn:hover { background:#2b394d; }
        .login-form .form-control.is-invalid { border-color: var(--bs-danger); background-image:none; }
        .error-summary { border:1px solid #dc2626; background:#fee2e2; color:#991b1b; border-radius:14px; padding:1rem 1.2rem; font-size:.85rem; margin-bottom:1rem; }
        [data-theme="dark"] .error-summary { background:#2d1f1f; color:#fca5a5; border-color:#7f1d1d; }
        @media (max-width: 991.98px) {
            .login-left { display:none; }
            .login-right { padding:2rem 1.25rem; }
            .login-form-container { box-shadow:none; background:transparent; padding:0; }
            [data-theme="dark"] .login-form-container { background:transparent; }
            .social-login-divider:before { background:#dbe3ef; }
        }
    </style>
</head>
<body class="login-body">
    <div class="container-fluid h-100">
        <div class="row h-100 g-0">
            <!-- Left Side -->
            <div class="col-lg-7 login-left">
                <div class="login-left-content">
                    <div class="login-logo" data-aos="fade-down">
                        <img src="{% static 'dist/img/logo/pandora-logo-white.png' %}" alt="Pandora ERP" class="img-fluid" style="max-width: 120px;">
                        <h1 class="display-4 fw-bold mt-3">Pandora ERP</h1>
                        <p class="lead">Sistema de Gestão Empresarial</p>
                    </div>
                    <div class="login-features" data-aos="fade-up" data-aos-delay="200">
                        <div class="feature-item">
                            <div class="feature-icon"><i class="bi bi-speedometer2"></i></div>
                            <div class="feature-content">
                                <h5>Gestão Completa</h5>
                                <p>Controle total do seu negócio em uma única plataforma</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="bi bi-shield-check"></i></div>
                            <div class="feature-content">
                                <h5>Segurança Total</h5>
                                <p>Seus dados protegidos com a mais alta segurança</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="bi bi-graph-up-arrow"></i></div>
                            <div class="feature-content">
                                <h5>Relatórios Avançados</h5>
                                <p>Análises detalhadas para decisões estratégicas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Side -->
            <div class="col-lg-5 login-right">
                <button type="button" class="toggle-theme-btn" id="toggleTheme" aria-label="Alternar tema"><i class="bi bi-moon-stars" id="themeIcon"></i><span class="d-none d-sm-inline" style="font-weight:600;font-size:.75rem;letter-spacing:.5px">TEMA</span></button>
                <div class="login-form-container" data-aos="fade-left" role="main">
                    <div class="login-form-header text-center">
                        <h2 class="h3 fw-bold">Bem-vindo de volta!</h2>
                        <p class="text-muted mb-0">Faça login para acessar sua conta.</p>
                        <p class="text-muted small mt-1">Ambiente seguro – use credenciais corporativas.</p>
                    </div>
                    
                    <!-- Unified Messages & Errors -->
                    {% if form.non_field_errors %}
                        <div class="error-summary" aria-live="assertive" aria-atomic="true">
                            <strong>Não foi possível entrar:</strong>
                            <ul class="mt-2 mb-0 ps-3">
                                {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    {% if messages %}
                        <div class="messages-container mb-3" aria-live="polite" aria-atomic="true">
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    <i class="bi bi-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %} me-2"></i>
                                    <div>{{ message }}</div>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Login Form -->
                    <form method="post" class="login-form" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label text-uppercase">{{ form.username.label }}</label>
                            <div class="input-group has-validation">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                {% render_field form.username class="form-control" placeholder="Seu usuário" autocomplete="username" autofocus="autofocus" %}
                            </div>
                            {% for error in form.username.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.password.id_for_label }}" class="form-label text-uppercase">{{ form.password.label }}</label>
                            <div class="input-group has-validation">
                                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                {% render_field form.password class="form-control" id="id_password" placeholder="Sua senha" autocomplete="current-password" %}
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword" aria-label="Mostrar/ocultar senha" title="Mostrar/ocultar senha">
                                    <i class="bi bi-eye" id="togglePasswordIcon"></i>
                                </button>
                            </div>
                            {% for error in form.password.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                            <div class="form-check m-0">
                                <input type="checkbox" class="form-check-input" id="rememberMe" name="remember_me">
                                <label class="form-check-label" for="rememberMe">Lembrar de mim</label>
                            </div>
                            {% url 'password_reset' as reset_url %}
                            <a href="{{ reset_url|default:'#' }}" class="text-decoration-none small {% if not reset_url %}disabled opacity-50{% endif %}" {% if not reset_url %}tabindex="-1" aria-disabled="true" title="Recuperação não configurada"{% endif %}>Esqueceu sua senha?</a>
                        </div>
                        
                        <div class="d-grid mb-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="loginBtn" data-loading-text="Entrando...">
                                <i class="bi bi-box-arrow-in-right me-1"></i><span>Entrar</span>
                            </button>
                        </div>
                    </form>

                    <div class="social-login-divider my-4" aria-hidden="true"><span class="text-muted">OU</span></div>
                    <div class="d-grid gap-2" aria-label="Login social (desativado)">
                        <button type="button" class="btn btn-social btn-google" disabled style="opacity:.55" title="Em breve">
                            <i class="bi bi-google"></i> Entrar com Google (em breve)
                        </button>
                        <button type="button" class="btn btn-social btn-microsoft" disabled style="opacity:.55" title="Em breve">
                            <i class="bi bi-microsoft"></i> Entrar com Microsoft (em breve)
                        </button>
                    </div>
                    
                    <div class="login-footer mt-4 text-center">
                        <p class="text-muted small mb-0">&copy; {% now "Y" %} Pandora ERP. Todos os direitos reservados.</p>
                        <p class="text-muted small mb-0">Versão: {{ VERSION|default:"N/D" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 750, once: true });

        // Password visibility toggle
        (function() {
            const btn = document.getElementById('togglePassword');
            if (!btn) return;
            btn.addEventListener('click', () => {
                const field = document.getElementById('id_password');
                const icon = document.getElementById('togglePasswordIcon');
                if (field.type === 'password') {
                    field.type = 'text';
                    icon.className = 'bi bi-eye-slash';
                } else {
                    field.type = 'password';
                    icon.className = 'bi bi-eye';
                }
                field.focus();
            });
        })();

        // Add is-invalid class programatically where there are corresponding error divs
        (function() {
            const invalidBlocks = document.querySelectorAll('.invalid-feedback');
            invalidBlocks.forEach(block => {
                const group = block.previousElementSibling;
                if (group && group.querySelector('.form-control')) {
                    group.querySelector('.form-control').classList.add('is-invalid');
                }
            });
        })();

        // Theme toggle with persistence
        (function() {
            const STORAGE_KEY = 'pandora-theme';
            const root = document.documentElement;
            const btn = document.getElementById('toggleTheme');
            const icon = document.getElementById('themeIcon');
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved === 'dark') root.setAttribute('data-theme','dark');
            updateIcon();
            btn?.addEventListener('click', () => {
                const current = root.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                root.setAttribute('data-theme', next);
                localStorage.setItem(STORAGE_KEY, next);
                updateIcon();
            });
            function updateIcon(){
                const isDark = root.getAttribute('data-theme') === 'dark';
                if (icon){ icon.className = isDark ? 'bi bi-brightness-high' : 'bi bi-moon-stars'; }
            }
        })();

        // Disable button on submit to prevent double POST
        (function() {
            const form = document.querySelector('.login-form');
            if (!form) return;
            const btn = document.getElementById('loginBtn');
            form.addEventListener('submit', () => {
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    const span = btn.querySelector('span');
                    if (span) span.textContent = 'Entrando...';
                }
            });
        })();
    </script>
</body>
</html>
