{% extends "pandora_list_ultra_modern.html" %}
{% load static %}

{% block title %}Gerenciamento de Usuários - Pandora ERP{% endblock %}

{% block page_title %}Gerenciamento de Usuários{% endblock %}
{% block page_subtitle %}Controle total dos usuários vinculados à empresa{% endblock %}

{% block add_button_url %}{% url 'core:tenant_user_create' %}{% endblock %}
{% block add_button_text %}Novo Usuário{% endblock %}

{% block add_url %}{% url 'core:tenant_user_create' %}{% endblock %}

{% block table_content %}
{% if tenant_users %}
<div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
            <tr>
                <th class="px-4 py-3 border-0" style="width: 200px;">
                    <i class="fas fa-user me-2"></i>Usuário
                </th>
                <th class="px-4 py-3 border-0" style="width: 180px;">
                    <i class="fas fa-envelope me-2"></i>Email
                </th>
                <th class="px-4 py-3 border-0" style="width: 160px;">
                    <i class="fas fa-building me-2"></i>Empresa
                </th>
                <th class="px-4 py-3 border-0 text-center" style="width: 140px;">
                    <i class="fas fa-user-tag me-2"></i>Função
                </th>
                <th class="px-4 py-3 border-0 text-center" style="width: 110px;">
                    <i class="fas fa-toggle-on me-2"></i>Status
                </th>
                <th class="px-4 py-3 border-0 text-center" style="width: 130px;">
                    <i class="fas fa-clock me-2"></i>Último Login
                </th>
                <th class="px-4 py-3 border-0 text-center" style="width: 250px;">
                    <i class="fas fa-cogs me-2"></i>Ações
                </th>
            </tr>
        </thead>
        <tbody>
            {% for tenant_user in tenant_users %}
                <tr class="tenant-user-row" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1|floatformat:0|add:'00' }}">
                    <td class="px-4 py-3">
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3">
                                {% if tenant_user.user.profile_image %}
                                    <img src="{{ tenant_user.user.profile_image.url }}" 
                                         alt="{{ tenant_user.user.get_full_name|default:tenant_user.user.username }}" 
                                         class="rounded-circle" width="40" height="40">
                                {% else %}
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <span class="fw-bold">{{ tenant_user.user.first_name|first|default:tenant_user.user.username|first|upper }}</span>
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                <div class="fw-bold text-dark">
                                    {% if tenant_user.user.first_name or tenant_user.user.last_name %}
                                        {{ tenant_user.user.get_full_name }}
                                    {% else %}
                                        {{ tenant_user.user.username }}
                                    {% endif %}
                                    {% if tenant_user.user.is_superuser %}
                                        <span class="badge bg-warning text-dark ms-2" title="Superusuário">
                                            <i class="fas fa-crown"></i> Super
                                        </span>
                                    {% endif %}
                                </div>
                                <small class="text-muted d-block">@{{ tenant_user.user.username }}</small>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-muted">
                            {% if tenant_user.user.email %}
                                {{ tenant_user.user.email }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div>
                            <div class="fw-bold text-dark">{{ tenant_user.tenant.name|default:tenant_user.tenant.razao_social }}</div>
                            {% if tenant_user.tenant.cnpj %}
                                <small class="text-muted">CNPJ: {{ tenant_user.tenant.cnpj }}</small>
                            {% elif tenant_user.tenant.cpf %}
                                <small class="text-muted">CPF: {{ tenant_user.tenant.cpf }}</small>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if tenant_user.is_tenant_admin %}
                            <span class="badge bg-success rounded-pill">
                                <i class="fas fa-user-shield me-1"></i>Administrador
                            </span>
                        {% else %}
                            <span class="badge bg-secondary rounded-pill">
                                <i class="fas fa-user me-1"></i>Usuário
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if tenant_user.user.is_active %}
                            <span class="badge bg-success rounded-pill">
                                <i class="fas fa-check-circle me-1"></i>Ativo
                            </span>
                        {% else %}
                            <span class="badge bg-danger rounded-pill">
                                <i class="fas fa-times-circle me-1"></i>Inativo
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if tenant_user.user.last_login %}
                            <div class="d-flex flex-column align-items-center">
                                <span class="text-dark fw-medium">{{ tenant_user.user.last_login|date:"d/m/Y" }}</span>
                                <small class="text-muted">{{ tenant_user.user.last_login|time:"H:i" }}</small>
                            </div>
                        {% else %}
                            <span class="text-muted">
                                <i class="fas fa-minus-circle me-1"></i>Nunca
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        <div class="d-flex gap-1 justify-content-center">
                            <a href="{% url 'core:tenant_user_detail' tenant_user.pk %}" 
                               class="btn btn-outline-info btn-action-sm" 
                               title="Ver Detalhes" 
                               data-bs-toggle="tooltip">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'core:tenant_user_update' tenant_user.pk %}" 
                               class="btn btn-outline-primary btn-action-sm" 
                               title="Editar" 
                               data-bs-toggle="tooltip">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'core:tenant_user_permissions' tenant_user.pk %}" 
                               class="btn btn-outline-success btn-action-sm" 
                               title="Permissões" 
                               data-bs-toggle="tooltip">
                                <i class="fas fa-key"></i>
                            </a>
                            <a href="{% url 'core:tenant_user_toggle_status' tenant_user.pk %}" 
                               class="btn btn-outline-{% if tenant_user.user.is_active %}warning{% else %}success{% endif %} btn-action-sm" 
                               title="{% if tenant_user.user.is_active %}Desativar{% else %}Ativar{% endif %} Usuário" 
                               data-bs-toggle="tooltip">
                                <i class="fas fa-{% if tenant_user.user.is_active %}toggle-off{% else %}toggle-on{% endif %}"></i>
                            </a>
                            <a href="{% url 'core:tenant_user_reset_password' tenant_user.pk %}" 
                               class="btn btn-outline-secondary btn-action-sm" 
                               title="Resetar Senha" 
                               data-bs-toggle="tooltip">
                                <i class="fas fa-unlock-alt"></i>
                            </a>
                            <a href="{% url 'core:tenant_user_delete' tenant_user.pk %}" 
                               class="btn btn-outline-danger btn-action-sm" 
                               title="Excluir" 
                               data-bs-toggle="tooltip" 
                               onclick="return confirm('ATENÇÃO: Confirma a exclusão definitiva do usuário {{ tenant_user.user.get_full_name|default:tenant_user.user.username }}? Esta ação não pode ser desfeita!')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">
        <i class="fas fa-users"></i>
    </div>
    <h3>Nenhum usuário encontrado</h3>
    <p>Adicione o primeiro usuário para começar.</p>
    <a href="{% url 'core:tenant_user_create' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Adicionar Usuário
    </a>
</div>
{% endif %}
{% endblock %}

