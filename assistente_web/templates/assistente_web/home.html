{% extends 'pandora_ultra_modern_base.html' %}
{% load static %}

{% block title %}Assistente de IA - Pandora ERP{% endblock %}

{% block page_title %}Assistente de IA{% endblock %}
{% block page_subtitle %}Seu assistente virtual inteligente para o sistema Pandora ERP{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button class="btn btn-outline-primary" onclick="novaConversa()">
        <i class="fas fa-plus me-2"></i>Nova Conversa
    </button>
    <a href="{% url 'assistente_web:configuracoes' %}" class="btn btn-outline-secondary">
        <i class="fas fa-cog me-2"></i>Configura√ß√µes
    </a>
    <a href="{% url 'assistente_web:historico' %}" class="btn btn-outline-info">
        <i class="fas fa-history me-2"></i>Hist√≥rico
    </a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 600px;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f8f9fa;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        animation: fadeInUp 0.3s ease-out;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.assistant {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 75%;
        padding: 0.875rem 1.125rem;
        border-radius: 20px;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .message.user .message-bubble {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border-bottom-right-radius: 6px;
    }
    
    .message.assistant .message-bubble {
        background: white;
        border: 1px solid #e3e6f0;
        border-bottom-left-radius: 6px;
        color: #5a5c69;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.8);
        margin-top: 0.25rem;
        text-align: right;
    }
    
    .message.assistant .message-time {
        color: #858796;
    }
    
    .chat-input {
        border-top: 1px solid #e3e6f0;
        padding: 1rem;
        background: white;
    }
    
    .typing-indicator {
        display: none;
        padding: 0.75rem 1.5rem;
        font-style: italic;
        color: #858796;
        background: #f8f9fa;
        border-top: 1px solid #e3e6f0;
    }
    
    .sidebar-conversations {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .conversation-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f1f1f1;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: var(--border-radius);
        margin-bottom: 0.25rem;
    }
    
    .conversation-item:hover {
        background-color: #f8f9fa;
        transform: translateX(2px);
    }
    
    .conversation-item.active {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-left: 4px solid #2196f3;
    }
    
    .quick-actions {
        margin-bottom: 1.5rem;
    }
    
    .quick-action-btn {
        margin: 0.125rem;
        font-size: 0.8rem;
        border-radius: var(--border-radius);
        transition: all 0.2s ease;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .welcome-message {
        text-align: center;
        padding: 3rem 2rem;
        color: #858796;
    }
    
    .welcome-message .fa-robot {
        color: #5a5c69;
        margin-bottom: 1rem;
    }
    
    .welcome-message h4 {
        color: #5a5c69;
        margin-bottom: 1rem;
    }
    
    .welcome-message ul {
        text-align: left;
        max-width: 300px;
        margin: 0 auto;
    }
    
    .assistant-sidebar {
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        border-radius: var(--border-radius-lg);
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Sidebar com conversas e a√ß√µes r√°pidas -->
    <div class="col-lg-3">
        <div class="card h-100 assistant-sidebar">
            <div class="card-header d-flex align-items-center bg-transparent border-0">
                <i class="fas fa-robot text-primary me-2"></i>
                <h5 class="mb-0">Assistente IA</h5>
            </div>
            <div class="card-body">
                <!-- A√ß√µes r√°pidas -->
                <div class="quick-actions">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-bolt me-1"></i>
                        A√ß√µes R√°pidas
                    </h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm quick-action-btn" onclick="enviarComando('consultar funcion√°rios')">
                            <i class="fas fa-users me-2"></i>Funcion√°rios
                        </button>
                        <button class="btn btn-outline-success btn-sm quick-action-btn" onclick="enviarComando('consultar clientes')">
                            <i class="fas fa-handshake me-2"></i>Clientes
                        </button>
                        <button class="btn btn-outline-warning btn-sm quick-action-btn" onclick="enviarComando('consultar obras')">
                            <i class="fas fa-building me-2"></i>Obras
                        </button>
                        <button class="btn btn-outline-info btn-sm quick-action-btn" onclick="enviarComando('consultar financeiro')">
                            <i class="fas fa-chart-line me-2"></i>Financeiro
                        </button>
                        <button class="btn btn-outline-secondary btn-sm quick-action-btn" onclick="enviarComando('abrir dashboard')">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </button>
                        <button class="btn btn-outline-dark btn-sm quick-action-btn" onclick="enviarComando('ajuda')">
                            <i class="fas fa-question-circle me-2"></i>Ajuda
                        </button>
                    </div>
                </div>
                
                <!-- Nova conversa -->
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-success btn-sm" onclick="novaConversa()">
                        <i class="fas fa-plus me-2"></i>Nova Conversa
                    </button>
                </div>
                
                <!-- Conversas recentes -->
                <div>
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-history me-1"></i>
                        Conversas Recentes
                    </h6>
                    <div class="sidebar-conversations">
                        {% for conversa in conversas_recentes %}
                        <div class="conversation-item {% if conversa.ativa %}active{% endif %}" 
                             onclick="carregarConversa({{ conversa.id }})">
                            <div class="fw-semibold">{{ conversa.titulo }}</div>
                            <small class="text-muted">{{ conversa.data_inicio|date:"d/m/Y H:i" }}</small>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-comments fa-2x mb-2"></i>
                            <p class="small mb-0">Nenhuma conversa ainda</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat principal -->
    <div class="col-lg-9">
        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        Assistente IA Pandora
                    </h5>
                    <small class="opacity-75">Pronto para ajudar com seu ERP</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-light btn-sm" onclick="window.location.href='{% url 'assistente_web:configuracoes' %}'" title="Configura√ß√µes">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="btn btn-light btn-sm" onclick="window.location.href='{% url 'assistente_web:historico' %}'" title="Hist√≥rico">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </div>
                
                <div class="chat-messages" id="chatMessages">
                    {% if not conversa_ativa %}
                    <div class="welcome-message">
                        <i class="fas fa-robot fa-4x mb-4"></i>
                        <h4>Ol√°! Sou seu assistente IA do Pandora ERP</h4>
                        <p class="mb-4">Digite uma mensagem ou use as a√ß√µes r√°pidas para come√ßar!</p>
                        
                        <div class="row text-start">
                            <div class="col-md-6">
                                <p><strong>üíº Exemplos de consultas:</strong></p>
                                <ul class="list-unstyled text-muted">
                                    <li>‚Ä¢ "Consultar funcion√°rio Jo√£o"</li>
                                    <li>‚Ä¢ "Mostrar dados financeiros"</li>
                                    <li>‚Ä¢ "Qual o status das obras?"</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <p><strong>üéØ Funcionalidades:</strong></p>
                                <ul class="list-unstyled text-muted">
                                    <li>‚Ä¢ Gerar relat√≥rios personalizados</li>
                                    <li>‚Ä¢ Lembrar informa√ß√µes importantes</li>
                                    <li>‚Ä¢ Navegar pelo sistema</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <i class="fas fa-robot"></i> Assistente est√° digitando...
                </div>
                
                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control border-0 shadow-sm" 
                               id="messageInput" 
                               placeholder="Digite sua mensagem..."
                               autocomplete="off"
                               style="border-radius: 25px 0 0 25px; padding: 0.75rem 1rem;">
                        <button class="btn btn-primary shadow-sm" 
                                type="button" 
                                onclick="enviarMensagem()"
                                style="border-radius: 0 25px 25px 0; padding: 0.75rem 1.25rem;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        {% if config.modo_preferido == 'voice' %}
                        <button class="btn btn-outline-secondary ms-2 shadow-sm" 
                                type="button" 
                                id="voiceBtn" 
                                onclick="iniciarGravacao()"
                                style="border-radius: 25px;">
                            <i class="fas fa-microphone"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let conversaAtual = {% if conversa_ativa %}{{ conversa_ativa.id }}{% else %}null{% endif %};
let gravando = false;

// Fun√ß√£o para enviar mensagem
function enviarMensagem() {
    const input = document.getElementById('messageInput');
    const mensagem = input.value.trim();
    
    if (!mensagem) return;
    
    // Adicionar mensagem do usu√°rio ao chat
    adicionarMensagem('user', mensagem);
    input.value = '';
    
    // Mostrar indicador de digita√ß√£o
    document.getElementById('typingIndicator').style.display = 'block';
    
    // Enviar para o servidor
    fetch('{% url "assistente_web:processar_comando" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            comando: mensagem,
            modo: 'text',
            conversa_id: conversaAtual
        })
    })
    .then(response => response.json())
    .then(data => {
        // Esconder indicador de digita√ß√£o
        document.getElementById('typingIndicator').style.display = 'none';
        
        if (data.status === 'success') {
            // Adicionar resposta do assistente
            adicionarMensagem('assistant', data.response);
            
            // Atualizar ID da conversa
            conversaAtual = data.conversa_id;
            
            // Processar a√ß√µes especiais
            if (data.action_data && data.action_data.redirect) {
                setTimeout(() => {
                    window.location.href = data.action_data.redirect;
                }, 2000);
            }
        } else {
            adicionarMensagem('assistant', 'Desculpe, ocorreu um erro: ' + data.message);
        }
    })
    .catch(error => {
        document.getElementById('typingIndicator').style.display = 'none';
        adicionarMensagem('assistant', 'Erro de conex√£o. Tente novamente.');
        console.error('Erro:', error);
    });
}

// Fun√ß√£o para adicionar mensagem ao chat
function adicionarMensagem(tipo, conteudo) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${tipo}`;
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${conteudo}
            <div class="message-time">${timeStr}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Fun√ß√£o para enviar comando r√°pido
function enviarComando(comando) {
    document.getElementById('messageInput').value = comando;
    enviarMensagem();
}

// Fun√ß√£o para nova conversa
function novaConversa() {
    fetch('{% url "assistente_web:nova_conversa" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            conversaAtual = data.conversa_id;
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-message">
                    <i class="fas fa-robot fa-4x mb-4 text-success"></i>
                    <h4>‚ú® Nova conversa iniciada!</h4>
                    <p class="text-success">Como posso ajudar voc√™ hoje?</p>
                    <div class="mt-4">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="enviarComando('ajuda')">
                            Ver comandos dispon√≠veis
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="enviarComando('consultar dashboard')">
                            Ver resumo do sistema
                        </button>
                    </div>
                </div>
            `;
            setTimeout(() => location.reload(), 1500); // Recarregar para atualizar sidebar
        }
    });
}

// Fun√ß√£o para carregar conversa
function carregarConversa(conversaId) {
    fetch(`{% url "assistente_web:obter_conversa" 0 %}`.replace('0', conversaId))
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            conversaAtual = conversaId;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            data.mensagens.forEach(msg => {
                adicionarMensagem(msg.tipo, msg.conteudo);
            });
        }
    });
}

// Enter para enviar mensagem
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        enviarMensagem();
    }
});

// Carregar conversa ativa se existir
{% if conversa_ativa %}
window.addEventListener('load', function() {
    carregarConversa({{ conversa_ativa.id }});
});
{% endif %}
</script>
{% endblock %}
