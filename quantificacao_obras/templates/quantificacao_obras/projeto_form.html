{% extends "pandora_ultra_modern_base.html" %}
{% load static %}

{% block title %}
    {% if object %}
        Editar Projeto - {{ object.nome }} - Pandora ERP
    {% else %}
        Novo Projeto de Quantificação - Pandora ERP
    {% endif %}
{% endblock %}

{% block page_title %}
    {% if object %}
        Editar Projeto
    {% else %}
        Novo Projeto de Quantificação
    {% endif %}
{% endblock %}

{% block page_subtitle %}
    {% if object %}
        Atualize as informações do projeto {{ object.nome }}
    {% else %}
        Crie um novo projeto de quantificação de obras
    {% endif %}
{% endblock %}

{% block page_icon %}fas fa-calculator{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'quantificacao_obras:projeto_list' %}">Quantificação de Obras</a></li>
<li class="breadcrumb-item active">
    {% if object %}
        Editar Projeto
    {% else %}
        Novo Projeto
    {% endif %}
</li>
{% endblock %}

{% block extra_css %}
<style>
    .form-wizard {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        backdrop-filter: blur(10px);
        overflow: hidden;
    }
    
    .wizard-steps {
        display: flex;
        background: var(--background-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 0;
        margin: 0;
    }
    
    .wizard-step {
        flex: 1;
        padding: 1rem;
        text-align: center;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
        background: transparent;
        border: none;
        color: var(--text-muted);
    }
    
    .wizard-step.active {
        color: var(--primary-color);
        background: var(--primary-bg);
    }
    
    .wizard-step.completed {
        color: var(--success-color);
        background: var(--success-bg);
    }
    
    .wizard-step:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 0;
        top: 50%;
        width: 1px;
        height: 30px;
        background: var(--border-color);
        transform: translateY(-50%);
    }
    
    .step-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .step-label {
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .form-section {
        padding: 2rem;
    }
    
    .form-section.d-none {
        display: none !important;
    }
    
    .form-floating {
        margin-bottom: 1.5rem;
    }
    
    .form-floating label {
        color: var(--text-muted);
        font-weight: 500;
    }
    
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
    }
    
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
    }
    
    .date-input-group {
        position: relative;
    }
    
    .date-input-group .form-control {
        padding-right: 3rem;
    }
    
    .date-input-group .date-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
        z-index: 5;
    }
    
    .status-selector {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .status-option {
        flex: 1;
        position: relative;
    }
    
    .status-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .status-option label {
        display: block;
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--card-bg);
    }
    
    .status-option input[type="radio"]:checked + label {
        border-color: var(--primary-color);
        background: var(--primary-bg);
        color: var(--primary-color);
    }
    
    .status-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .status-label {
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding: 1.5rem 2rem;
        background: var(--background-secondary);
        border-top: 1px solid var(--border-color);
    }
    
    .btn-wizard {
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-wizard:hover {
        transform: translateY(-1px);
    }
    
    .btn-wizard:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .form-help {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }
    
    .required-indicator {
        color: var(--danger-color);
        font-weight: bold;
    }
    
    .form-group-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .form-group-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .form-group-subtitle {
        color: var(--text-muted);
        font-size: 0.875rem;
    }
    
    .auto-save-indicator {
        display: none;
        align-items: center;
        gap: 0.5rem;
        color: var(--success-color);
        font-size: 0.875rem;
        margin-left: 1rem;
    }
    
    .auto-save-indicator.show {
        display: flex;
    }
    
    .spinner {
        width: 1rem;
        height: 1rem;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-12">
            <form method="post" class="needs-validation" novalidate id="projectForm">
                {% csrf_token %}
                
                <div class="form-wizard">
                    <!-- Steps -->
                    <div class="wizard-steps">
                        <button type="button" class="wizard-step active" data-step="1">
                            <i class="fas fa-info-circle step-icon"></i>
                            <div class="step-label">Informações Básicas</div>
                        </button>
                        <button type="button" class="wizard-step" data-step="2">
                            <i class="fas fa-calendar-alt step-icon"></i>
                            <div class="step-label">Cronograma</div>
                        </button>
                        <button type="button" class="wizard-step" data-step="3">
                            <i class="fas fa-user-tie step-icon"></i>
                            <div class="step-label">Responsável</div>
                        </button>
                        <button type="button" class="wizard-step" data-step="4">
                            <i class="fas fa-check-circle step-icon"></i>
                            <div class="step-label">Finalização</div>
                        </button>
                    </div>
                    
                    <!-- Step 1: Informações Básicas -->
                    <div class="form-section" data-step="1">
                        <div class="form-group-header">
                            <h3 class="form-group-title">Informações Básicas</h3>
                            <p class="form-group-subtitle">Defina as informações principais do projeto</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="nome" name="nome" 
                                           value="{{ form.nome.value|default:'' }}" required>
                                    <label for="nome">Nome do Projeto <span class="required-indicator">*</span></label>
                                    <div class="form-help">Digite um nome descritivo para o projeto</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="status" name="status" required>
                                        <option value="">Selecione o status</option>
                                        <option value="rascunho" {% if form.status.value == 'rascunho' %}selected{% endif %}>Rascunho</option>
                                        <option value="em_andamento" {% if form.status.value == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                                        <option value="concluido" {% if form.status.value == 'concluido' %}selected{% endif %}>Concluído</option>
                                        <option value="cancelado" {% if form.status.value == 'cancelado' %}selected{% endif %}>Cancelado</option>
                                    </select>
                                    <label for="status">Status <span class="required-indicator">*</span></label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-floating">
                            <textarea class="form-control" id="descricao" name="descricao" 
                                      style="height: 120px;">{{ form.descricao.value|default:'' }}</textarea>
                            <label for="descricao">Descrição</label>
                            <div class="form-help">Descreva brevemente o projeto e seus objetivos</div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Cronograma -->
                    <div class="form-section d-none" data-step="2">
                        <div class="form-group-header">
                            <h3 class="form-group-title">Cronograma</h3>
                            <p class="form-group-subtitle">Defina as datas importantes do projeto</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <div class="date-input-group">
                                        <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                                               value="{{ form.data_inicio.value|date:'Y-m-d'|default:'' }}" required>
                                        <i class="fas fa-calendar-alt date-icon"></i>
                                    </div>
                                    <label for="data_inicio">Data de Início <span class="required-indicator">*</span></label>
                                    <div class="form-help">Data de início do projeto</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <div class="date-input-group">
                                        <input type="date" class="form-control" id="data_previsao_conclusao" name="data_previsao_conclusao" 
                                               value="{{ form.data_previsao_conclusao.value|date:'Y-m-d'|default:'' }}">
                                        <i class="fas fa-calendar-alt date-icon"></i>
                                    </div>
                                    <label for="data_previsao_conclusao">Previsão de Conclusão</label>
                                    <div class="form-help">Data prevista para finalização do projeto</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Dica:</strong> Defina prazos realistas considerando a complexidade do projeto e a disponibilidade da equipe.
                        </div>
                    </div>
                    
                    <!-- Step 3: Responsável -->
                    <div class="form-section d-none" data-step="3">
                        <div class="form-group-header">
                            <h3 class="form-group-title">Responsável</h3>
                            <p class="form-group-subtitle">Defina quem será responsável pelo projeto</p>
                        </div>
                        
                        <div class="form-floating">
                            <select class="form-select" id="responsavel" name="responsavel">
                                <option value="">Selecione um responsável</option>
                                {% for user in users %}
                                    <option value="{{ user.id }}" 
                                            {% if form.responsavel.value == user.id %}selected{% endif %}>
                                        {{ user.get_full_name|default:user.username }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="responsavel">Responsável</label>
                            <div class="form-help">Selecione o usuário responsável pelo projeto</div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Importante:</strong> O responsável receberá notificações sobre o progresso do projeto.
                        </div>
                    </div>
                    
                    <!-- Step 4: Finalização -->
                    <div class="form-section d-none" data-step="4">
                        <div class="form-group-header">
                            <h3 class="form-group-title">Finalização</h3>
                            <p class="form-group-subtitle">Revise as informações antes de salvar</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Resumo do Projeto</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Nome:</strong> <span id="review-nome">-</span></p>
                                        <p><strong>Status:</strong> <span id="review-status">-</span></p>
                                        <p><strong>Data de Início:</strong> <span id="review-data-inicio">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Previsão de Conclusão:</strong> <span id="review-data-previsao">-</span></p>
                                        <p><strong>Responsável:</strong> <span id="review-responsavel">-</span></p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p><strong>Descrição:</strong></p>
                                    <p class="text-muted" id="review-descricao">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>Pronto!</strong> Clique em "Salvar Projeto" para finalizar.
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div class="auto-save-indicator" id="autoSaveIndicator">
                            <div class="spinner"></div>
                            <span>Salvando automaticamente...</span>
                        </div>
                        <button type="button" class="btn btn-secondary btn-wizard" id="prevBtn" style="display: none;">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary btn-wizard" id="nextBtn">
                            Próximo <i class="fas fa-arrow-right"></i>
                        </button>
                        <button type="submit" class="btn btn-success btn-wizard" id="submitBtn" style="display: none;">
                            <i class="fas fa-save"></i> Salvar Projeto
                        </button>
                        <a href="{% url 'quantificacao_obras:projeto_list' %}" class="btn btn-outline-secondary btn-wizard">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('projectForm');
    const steps = document.querySelectorAll('.wizard-step');
    const sections = document.querySelectorAll('.form-section');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    const autoSaveIndicator = document.getElementById('autoSaveIndicator');
    
    let currentStep = 1;
    const totalSteps = steps.length;
    
    // Função para mostrar/ocultar steps
    function showStep(step) {
        // Ocultar todas as seções
        sections.forEach(section => {
            section.classList.add('d-none');
        });
        
        // Mostrar seção atual
        const currentSection = document.querySelector(`[data-step="${step}"]`);
        if (currentSection) {
            currentSection.classList.remove('d-none');
        }
        
        // Atualizar estado dos botões do wizard
        steps.forEach((stepBtn, index) => {
            stepBtn.classList.remove('active', 'completed');
            if (index + 1 === step) {
                stepBtn.classList.add('active');
            } else if (index + 1 < step) {
                stepBtn.classList.add('completed');
            }
        });
        
        // Controlar botões de navegação
        prevBtn.style.display = step > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = step < totalSteps ? 'inline-block' : 'none';
        submitBtn.style.display = step === totalSteps ? 'inline-block' : 'none';
        
        // Atualizar review na última etapa
        if (step === totalSteps) {
            updateReview();
        }
    }
    
    // Função para validar step atual
    function validateCurrentStep() {
        const currentSection = document.querySelector(`[data-step="${currentStep}"]`);
        const requiredFields = currentSection.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        return isValid;
    }
    
    // Função para atualizar review
    function updateReview() {
        const nome = document.getElementById('nome').value || '-';
        const status = document.getElementById('status').value || '-';
        const statusText = document.getElementById('status').selectedOptions[0]?.text || '-';
        const dataInicio = document.getElementById('data_inicio').value || '-';
        const dataPrevisao = document.getElementById('data_previsao_conclusao').value || '-';
        const responsavel = document.getElementById('responsavel').selectedOptions[0]?.text || 'Não atribuído';
        const descricao = document.getElementById('descricao').value || '-';
        
        document.getElementById('review-nome').textContent = nome;
        document.getElementById('review-status').textContent = statusText;
        document.getElementById('review-data-inicio').textContent = dataInicio ? new Date(dataInicio).toLocaleDateString('pt-BR') : '-';
        document.getElementById('review-data-previsao').textContent = dataPrevisao ? new Date(dataPrevisao).toLocaleDateString('pt-BR') : '-';
        document.getElementById('review-responsavel').textContent = responsavel;
        document.getElementById('review-descricao').textContent = descricao;
    }
    
    // Navegação entre steps
    nextBtn.addEventListener('click', function() {
        if (validateCurrentStep() && currentStep < totalSteps) {
            currentStep++;
            showStep(currentStep);
        }
    });
    
    prevBtn.addEventListener('click', function() {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });
    
    // Navegação clicando nos steps
    steps.forEach((step, index) => {
        step.addEventListener('click', function() {
            const targetStep = index + 1;
            if (targetStep <= currentStep || validateCurrentStep()) {
                currentStep = targetStep;
                showStep(currentStep);
            }
        });
    });
    
    // Validação em tempo real
    form.addEventListener('input', function(e) {
        if (e.target.hasAttribute('required')) {
            if (e.target.value.trim()) {
                e.target.classList.remove('is-invalid');
            }
        }
    });
    
    // Auto-save (simulado)
    let autoSaveTimeout;
    form.addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(function() {
            // Simular auto-save
            autoSaveIndicator.classList.add('show');
            setTimeout(() => {
                autoSaveIndicator.classList.remove('show');
            }, 2000);
        }, 2000);
    });
    
    // Validação de datas
    const dataInicio = document.getElementById('data_inicio');
    const dataPrevisao = document.getElementById('data_previsao_conclusao');
    
    dataInicio.addEventListener('change', function() {
        if (dataPrevisao.value && dataPrevisao.value < this.value) {
            dataPrevisao.value = this.value;
        }
        dataPrevisao.min = this.value;
    });
    
    // Inicializar
    showStep(1);
    
    // Definir data mínima como hoje
    const hoje = new Date().toISOString().split('T')[0];
    dataInicio.min = hoje;
    if (!dataInicio.value) {
        dataInicio.value = hoje;
    }
});
</script>
{% endblock %}
