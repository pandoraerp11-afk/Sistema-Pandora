{% extends "pandora_form_ultra_modern.html" %}
{% load static widget_tweaks %}

{% block title %}Meu Perfil - Pandora ERP{% endblock %}

{% block page_title %}Meu Perfil{% endblock %}

{% block page_subtitle %}
    Gerencie suas informações pessoais e configurações de conta
{% endblock %}

{% block form_title %}Configurações do Perfil{% endblock %}

{% block form_content %}
<div class="container-fluid py-4">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" data-aos="fade-up">
                        <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm" data-aos="fade-up">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" novalidate id="perfilForm">
                    {% csrf_token %}
                    
                    <!-- Informações Pessoais -->
                    <div class="row g-4">
                        <div class="col-12">
                            <h5 class="fw-bold text-primary mb-3">
                                <i class="fas fa-user me-2"></i>
                                Informações Pessoais
                            </h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-user text-primary"></i>
                                    Nome
                                </label>
                                {{ form.first_name|add_class:"form-control" }}
                                {% if form.first_name.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.first_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-user text-primary"></i>
                                    Sobrenome
                                </label>
                                {{ form.last_name|add_class:"form-control" }}
                                {% if form.last_name.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.last_name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-envelope text-primary"></i>
                                    E-mail
                                </label>
                                {{ form.email|add_class:"form-control" }}
                                {% if form.email.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.email.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-phone text-primary"></i>
                                    Telefone
                                </label>
                                {{ form.telefone|add_class:"form-control" }}
                                {% if form.telefone.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.telefone.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if form.avatar %}
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-image text-primary"></i>
                                    Avatar
                                </label>
                                {{ form.avatar|add_class:"form-control" }}
                                {% if form.avatar.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.avatar.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Imagem do perfil (formatos: JPG, PNG, GIF - máximo: 2MB)
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Informações Profissionais -->
                        {% if form.cargo or form.departamento or form.bio %}
                    <div class="row g-4 mt-4">
                        <div class="col-12">
                            <h5 class="fw-bold text-primary mb-3">
                                <i class="fas fa-briefcase me-2"></i>
                                Informações Profissionais
                            </h5>
                        </div>
                        
                        {% if form.cargo %}
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-id-badge text-primary"></i>
                                    Cargo
                                </label>
                                {{ form.cargo|add_class:"form-control" }}
                                {% if form.cargo.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.cargo.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if form.departamento %}
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-building text-primary"></i>
                                    Departamento
                                </label>
                                {{ form.departamento|add_class:"form-control" }}
                                {% if form.departamento.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.departamento.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if form.bio %}
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-align-left text-primary"></i>
                                    Biografia
                                </label>
                                {{ form.bio|add_class:"form-control" }}
                                {% if form.bio.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.bio.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Fale um pouco sobre você (opcional)
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                                        <!-- Preferências e Notificações -->
                                        <div class="row g-4 mt-4">
                                            <div class="col-12">
                                                <h5 class="fw-bold text-primary mb-3"><i class="fas fa-bell me-2"></i>Preferências</h5>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.receber_email_notificacoes|add_class:'form-check-input' }} <label class="form-check-label ms-1">Emails</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.receber_sms_notificacoes|add_class:'form-check-input' }} <label class="form-check-label ms-1">SMS</label>
                                            </div>
                                            <div class="col-md-4">
                                                {{ form.receber_push_notificacoes|add_class:'form-check-input' }} <label class="form-check-label ms-1">Push</label>
                                            </div>
                                        </div>

                                        <!-- Endereço (compacto) -->
                                        <div class="row g-3 mt-4">
                                            <div class="col-12">
                                                <h6 class="fw-bold text-secondary mb-2"><i class="fas fa-map-marker-alt me-2"></i>Endereço</h6>
                                            </div>
                                            <div class="col-md-8">{{ form.endereco|add_class:'form-control' }}</div>
                                            <div class="col-md-4">{{ form.numero|add_class:'form-control' }}</div>
                                            <div class="col-md-4">{{ form.complemento|add_class:'form-control' }}</div>
                                            <div class="col-md-4">{{ form.bairro|add_class:'form-control' }}</div>
                                            <div class="col-md-4">{{ form.cep|add_class:'form-control' }}</div>
                                            <div class="col-md-8">{{ form.cidade|add_class:'form-control' }}</div>
                                            <div class="col-md-4">{{ form.estado|add_class:'form-control' }}</div>
                                        </div>

                                        <!-- Form Actions -->
                    <div class="d-flex gap-3 justify-content-end mt-4">
                        <a href="{% url 'user_management:change_password' %}" class="btn btn-outline-warning">
                            <i class="fas fa-key me-2"></i>Alterar Senha
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Preview -->
        <div class="col-lg-4">
            <div class="card shadow-sm" data-aos="fade-up" data-aos-delay="200">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">
                        <i class="fas fa-eye me-2"></i>
                        Preview do Perfil
                    </h6>
                    
                    <div class="card border-0 bg-light">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                {% if user.perfil_estendido.avatar %}
                                    <img src="{{ user.perfil_estendido.avatar.url }}" alt="{{ user.get_full_name }}" class="rounded-circle" width="80" height="80" id="previewAvatar">
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center bg-primary text-white rounded-circle mx-auto" style="width: 80px; height: 80px;" id="previewAvatar">
                                        <i class="fas fa-user fs-3"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="fw-bold mb-1" id="previewName">
                                {{ user.get_full_name|default:user.username }}
                            </div>
                            <div class="text-muted small mb-2" id="previewEmail">
                                {{ user.email }}
                            </div>
                            <div class="text-muted small" id="previewCargo">
                                {% if user.perfil_estendido.cargo %}{{ user.perfil_estendido.cargo }}{% else %}Cargo não informado{% endif %}
                            </div>
                            
                            <div class="mt-3 pt-3 border-top">
                                <div class="small text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    Membro desde {{ user.date_joined|date:"M/Y" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Account Info -->
            <div class="card shadow-sm mt-3" data-aos="fade-up" data-aos-delay="300">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações da Conta
                    </h6>
                    
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-user-tag text-primary me-2"></i>
                            <small><strong>Tipo:</strong> {{ user.perfil_estendido.get_tipo_usuario_display|default:"Usuário Comum" }}</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calendar-alt text-primary me-2"></i>
                            <small><strong>Criada em:</strong> {{ user.date_joined|date:"d/m/Y" }}</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <small><strong>Último login:</strong> {% if user.last_login %}{{ user.last_login|date:"d/m/Y H:i" }}{% else %}Nunca{% endif %}</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-toggle-{% if user.is_active %}on text-success{% else %}off text-danger{% endif %} me-2"></i>
                            <small><strong>Status:</strong> {% if user.is_active %}Ativo{% else %}Inativo{% endif %}</small>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm mt-3" data-aos="fade-up" data-aos-delay="400">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">
                        <i class="fas fa-lightning-bolt me-2"></i>
                        Ações Rápidas
                    </h6>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'user_management:change_password' %}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-key me-1"></i>
                            Alterar Senha
                        </a>
                        {% if user.perfil_estendido %}
                        <a href="{% url 'user_management:usuario_detail' user.perfil_estendido.pk %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-eye me-1"></i>
                            Ver Perfil Completo
                        </a>
                        {% endif %}
                        <a href="{% url 'user_management:usuario_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-users me-1"></i>
                            Ver Outros Usuários
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Preview da imagem do avatar
    const avatarInput = document.querySelector('input[type="file"][name="avatar"]');
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const existingImg = document.querySelector('.avatar img');
                    if (existingImg) {
                        existingImg.src = e.target.result;
                    } else {
                        const avatarDiv = document.querySelector('.avatar div');
                        if (avatarDiv) {
                            avatarDiv.innerHTML = `<img src="${e.target.result}" alt="Preview" class="rounded-circle" width="120" height="120">`;
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});
</script>
{% endblock %}
