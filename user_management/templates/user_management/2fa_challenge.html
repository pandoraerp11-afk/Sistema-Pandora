{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-5" style="max-width:480px;">
  <h3>Verificação 2FA</h3>
  <p>Digite o código do seu aplicativo autenticador ou um código de recuperação.</p>
  <div class="alert alert-info small">Após confirmação você terá acesso completo.</div>
  <div id="msg" class="d-none alert"></div>
  <div id="lockout" class="d-none alert alert-warning small"></div>
  <form id="form2fa" method="post" action="{% url 'user_management:2fa_verify' %}">
    {% csrf_token %}
    <div class="mb-3">
      <label class="form-label">Código TOTP</label>
      <input type="text" name="token" class="form-control" autocomplete="one-time-code" maxlength="10" />
    </div>
    <div class="text-center">-- OU --</div>
    <div class="mb-3">
      <label class="form-label">Código de Recuperação</label>
      <input type="text" name="recovery_code" class="form-control" maxlength="16" />
    </div>
    <button class="btn btn-primary w-100" type="submit">Verificar</button>
  </form>
</div>
<script>
const form = document.getElementById('form2fa');
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const resp = await fetch(form.action, {method:'POST', body: fd, headers:{'X-Requested-With':'XMLHttpRequest'}});
  const msg = document.getElementById('msg');
  if(resp.status === 423){
    const data = await resp.json().catch(()=>({detail:'2FA bloqueado temporariamente.'}));
    lock.textContent = data.detail;
    lock.classList.remove('d-none');
    msg.className='d-none';
    return;
  }
  if(resp.ok){
    msg.className='alert alert-success';
    msg.textContent='Verificação concluída.';
    msg.classList.remove('d-none');
    setTimeout(()=>window.location='/', 800);
  } else {
  const data = await resp.json().catch(()=>({detail:'Erro'}));
    msg.className='alert alert-danger';
    msg.textContent=data.detail||'Código inválido';
    msg.classList.remove('d-none');
  lock.classList.add('d-none');
  }
});
const lock = document.getElementById('lockout');
</script>
{% endblock %}
