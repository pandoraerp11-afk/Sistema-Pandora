{% extends "pandora_form_ultra_modern.html" %}
{% load static widget_tweaks %}

{% block title %}Alterar Senha - Pandora ERP{% endblock %}

{% block page_title %}Alterar Senha{% endblock %}

{% block page_subtitle %}
    Atualize sua senha para manter sua conta segura
{% endblock %}

{% block form_title %}Configuração de Senha{% endblock %}

{% block form_content %}
<div class="container-fluid py-4">
    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" data-aos="fade-up">
                        <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Form -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm" data-aos="fade-up">
                <div class="card-body">
                    <form method="post" novalidate id="passwordForm">
                    {% csrf_token %}
                    
                    <!-- Alterar Senha -->
                    <div class="row g-4">
                        <div class="col-12">
                            <h5 class="fw-bold text-primary mb-3">
                                <i class="fas fa-key me-2"></i>
                                Alterar Senha
                            </h5>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock text-primary"></i>
                                    Senha Atual
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.old_password|add_class:"form-control" }}
                                {% if form.old_password.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.old_password.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Digite sua senha atual para confirmar</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock text-primary"></i>
                                    Nova Senha
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.new_password1|add_class:"form-control" }}
                                {% if form.new_password1.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.new_password1.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Mínimo 8 caracteres com letras e números</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-lock text-primary"></i>
                                    Confirmar Nova Senha
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.new_password2|add_class:"form-control" }}
                                {% if form.new_password2.errors %}
                                    <div class="error-message text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ form.new_password2.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Digite a nova senha novamente</div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Info -->
                    <div class="row g-4 mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    Dicas de Segurança
                                </h6>
                                <ul class="mb-0">
                                    <li>Use uma combinação de letras maiúsculas, minúsculas, números e símbolos</li>
                                    <li>Evite usar informações pessoais óbvias</li>
                                    <li>Não reutilize senhas de outras contas</li>
                                    <li>Considere usar um gerenciador de senhas</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-3 justify-content-end mt-4">
                        <a href="{% url 'user_management:meu_perfil' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar ao Perfil
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Alterar Senha
                        </button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Security Tips -->
        <div class="col-lg-4">
            <div class="card shadow-sm" data-aos="fade-up" data-aos-delay="200">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">
                        <i class="fas fa-shield-alt me-2"></i>
                        Segurança da Conta
                    </h6>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                                <div>
                                    <div class="fw-bold small">Senha Segura</div>
                                    <div class="text-muted small">Use caracteres variados</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-clock text-warning"></i>
                                </div>
                                <div>
                                    <div class="fw-bold small">Alteração Regular</div>
                                    <div class="text-muted small">Mude sua senha periodicamente</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-eye-slash text-info"></i>
                                </div>
                                <div>
                                    <div class="fw-bold small">Mantenha em Segredo</div>
                                    <div class="text-muted small">Nunca compartilhe sua senha</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Account Status -->
            <div class="card shadow-sm mt-3" data-aos="fade-up" data-aos-delay="300">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Status da Conta
                    </h6>
                    
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-user text-primary me-2"></i>
                            <small><strong>Usuário:</strong> {{ user.get_full_name|default:user.username }}</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-envelope text-primary me-2"></i>
                            <small><strong>E-mail:</strong> {{ user.email }}</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <small><strong>Último login:</strong> {% if user.last_login %}{{ user.last_login|date:"d/m/Y H:i" }}{% else %}Nunca{% endif %}</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calendar text-primary me-2"></i>
                            <small><strong>Conta criada:</strong> {{ user.date_joined|date:"d/m/Y" }}</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.querySelector('input[name="new_password1"]');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    
    if (passwordInput && strengthBar && strengthText) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            
            // Atualizar barra de progresso
            strengthBar.style.width = strength.percentage + '%';
            strengthBar.className = 'progress-bar ' + strength.colorClass;
            strengthText.textContent = strength.text;
        });
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        if (password.length === 0) {
            return {
                percentage: 0,
                colorClass: '',
                text: 'Digite uma senha para ver sua força'
            };
        }
        
        // Comprimento
        if (password.length >= 8) score += 25;
        else feedback.push('mínimo 8 caracteres');
        
        // Letra minúscula
        if (/[a-z]/.test(password)) score += 25;
        else feedback.push('letra minúscula');
        
        // Letra maiúscula
        if (/[A-Z]/.test(password)) score += 25;
        else feedback.push('letra maiúscula');
        
        // Número
        if (/\d/.test(password)) score += 25;
        else feedback.push('número');
        
        // Símbolos especiais (bônus)
        if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) score += 10;
        
        let colorClass, text;
        
        if (score < 25) {
            colorClass = 'bg-danger';
            text = 'Muito fraca - Adicione: ' + feedback.join(', ');
        } else if (score < 50) {
            colorClass = 'bg-warning';
            text = 'Fraca - Adicione: ' + feedback.join(', ');
        } else if (score < 75) {
            colorClass = 'bg-info';
            text = 'Média - Pode melhorar: ' + feedback.join(', ');
        } else if (score < 100) {
            colorClass = 'bg-success';
            text = 'Forte - Boa senha!';
        } else {
            colorClass = 'bg-success';
            text = 'Muito forte - Excelente!';
        }
        
        return {
            percentage: Math.min(score, 100),
            colorClass: colorClass,
            text: text
        };
    }
});
</script>
{% endblock %}
