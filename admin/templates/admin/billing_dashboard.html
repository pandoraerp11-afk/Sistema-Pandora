{% extends "pandora_home_ultra_modern.html" %}
{% load i18n %}
{% load humanize %}
{% load static %}

{% block title %}üí∞ Faturamento e Planos - Pandora ERP{% endblock %}

{% block home_icon %}<i class="fas fa-credit-card me-2 text-primary"></i>{% endblock %}
{% block home_title %}Faturamento e Planos{% endblock %}
{% block home_subtitle %}Gerencie sua assinatura e hist√≥rico de pagamentos{% endblock %}

{% block home_stats %}
    <div class="mb-5">
        <h2 class="section-title" data-aos="fade-up">
            <i class="fas fa-chart-pie me-2 text-primary"></i>
            Resumo Financeiro
        </h2>
        <div class="row g-4" data-aos="fade-up" data-aos-delay="100">
            <!-- Plano Atual -->
            <div class="col-lg-3 col-md-6">
                <div class="billing-card primary h-100">
                    <div class="card-body p-4 text-center">
                        <div class="billing-icon bg-primary text-white mx-auto">
                            <i class="fas fa-crown"></i>
                        </div>
                        <h5 class="fw-bold text-primary mb-1">{{ current_plan.name }}</h5>
                        <p class="text-muted mb-1 fw-semibold">{% trans "Plano Atual" %}</p>
                        <small class="text-muted">V√°lido at√© {{ current_plan.expires_at }}</small>
                    </div>
                </div>
            </div>
            
            <!-- Valor Mensal -->
            <div class="col-lg-3 col-md-6">
                <div class="billing-card success h-100">
                    <div class="card-body p-4 text-center">
                        <div class="billing-icon bg-success text-white mx-auto">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h3 class="display-6 fw-bold text-success mb-1">R$ {{ monthly_cost|floatformat:2 }}</h3>
                        <p class="text-muted mb-1 fw-semibold">{% trans "Valor Mensal" %}</p>
                        <small class="text-muted">Pr√≥ximo pagamento {{ next_payment }}</small>
                    </div>
                </div>
            </div>
            
            <!-- Usu√°rios Inclusos -->
            <div class="col-lg-3 col-md-6">
                <div class="billing-card warning h-100">
                    <div class="card-body p-4 text-center">
                        <div class="billing-icon bg-warning text-white mx-auto">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 class="display-6 fw-bold text-warning mb-1">{{ current_users }}/{{ max_users }}</h3>
                        <p class="text-muted mb-1 fw-semibold">{% trans "Usu√°rios" %}</p>
                        <small class="text-muted">{{ users_remaining }} dispon√≠veis</small>
                    </div>
                </div>
            </div>
            
            <!-- Status */
            <div class="col-lg-3 col-md-6">
                <div class="billing-card info h-100">
                    <div class="card-body p-4 text-center">
                        <div class="billing-icon bg-{{ billing_status.color }} text-white mx-auto">
                            <i class="{{ billing_status.icon }}"></i>
                        </div>
                        <h5 class="fw-bold text-{{ billing_status.color }} mb-1">{{ billing_status.text }}</h5>
                        <p class="text-muted mb-1 fw-semibold">{% trans "Status" %}</p>
                        <small class="text-muted">{{ billing_status.description }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block home_actions %}
    <!-- Planos Dispon√≠veis -->
    <div class="mb-5">
        <h2 class="section-title" data-aos="fade-up">
            <i class="fas fa-layer-group me-2 text-primary"></i>
            {% trans "Planos Dispon√≠veis" %}
        </h2>
        <div class="row g-4" data-aos="fade-up" data-aos-delay="200">
            {% for plan in available_plans %}
            <div class="col-lg-4" data-aos="fade-up" data-aos-delay="{{ forloop.counter|add:2 }}00">
                <div class="plan-card h-100 {% if plan.is_current %}current{% endif %} {% if plan.is_popular %}popular{% endif %}">
                    {% if plan.is_popular %}
                    <div class="plan-badge">
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-star me-1"></i>
                            Mais Popular
                        </span>
                    </div>
                    {% endif %}
                    
                    <div class="card-body p-4 text-center">
                        <div class="plan-icon bg-gradient-{{ plan.color }} text-white mx-auto mb-3">
                            <i class="{{ plan.icon }}"></i>
                        </div>
                        
                        <h4 class="plan-name mb-2">{{ plan.name }}</h4>
                        <p class="plan-description text-muted mb-3">{{ plan.description }}</p>
                        
                        <div class="plan-price mb-4">
                            <h2 class="display-4 fw-bold text-{{ plan.color }} mb-0">
                                R$ {{ plan.price|floatformat:2 }}
                                <small class="fs-6 text-muted">/m√™s</small>
                            </h2>
                        </div>
                        
                        <div class="plan-features mb-4">
                            <ul class="list-unstyled">
                                {% for feature in plan.features %}
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    {{ feature }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="plan-actions">
                            {% if plan.is_current %}
                                <button class="btn btn-outline-success btn-lg w-100" disabled>
                                    <i class="fas fa-check me-2"></i>
                                    Plano Atual
                                </button>
                            {% else %}
                                <button class="btn btn-{{ plan.color }} btn-lg w-100" onclick="changePlan('{{ plan.id }}')">
                                    <i class="fas fa-arrow-up me-2"></i>
                                    {% if plan.is_upgrade %}Fazer Upgrade{% else %}Selecionar{% endif %}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Hist√≥rico de Faturas -->
    <div class="mb-5">
        <h2 class="section-title" data-aos="fade-up">
            <i class="fas fa-file-invoice me-2 text-primary"></i>
            {% trans "Hist√≥rico de Faturas" %}
        </h2>
        <div class="invoice-table-card" data-aos="fade-up" data-aos-delay="100">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">{% trans "Fatura" %}</th>
                                <th>{% trans "Data" %}</th>
                                <th>{% trans "Valor" %}</th>
                                <th>{% trans "Status" %}</th>
                                <th>{% trans "M√©todo" %}</th>
                                <th class="pe-4">{% trans "A√ß√µes" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="invoice-icon bg-light text-primary me-3">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">#{{ invoice.number }}</div>
                                            <small class="text-muted">{{ invoice.description }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>{{ invoice.date }}</div>
                                    <small class="text-muted">{{ invoice.due_date }}</small>
                                </td>
                                <td>
                                    <strong class="text-primary">R$ {{ invoice.amount|floatformat:2 }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-{{ invoice.status.color }}">
                                        <i class="{{ invoice.status.icon }} me-1"></i>
                                        {{ invoice.status.text }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="{{ invoice.method.icon }} me-2 text-muted"></i>
                                        {{ invoice.method.name }}
                                    </div>
                                </td>
                                <td class="pe-4">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="downloadInvoice('{{ invoice.id }}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="viewInvoice('{{ invoice.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if invoice.can_pay %}
                                        <button class="btn btn-outline-success" onclick="payInvoice('{{ invoice.id }}')">
                                            <i class="fas fa-credit-card"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block home_recent %}
    <div class="row g-4 mb-5">
        <!-- Gr√°fico de Gastos -->
        <div class="col-lg-8" data-aos="fade-up">
            <div class="chart-card">
                <div class="card-header bg-transparent border-0 p-4 pb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            {% trans "Hist√≥rico de Gastos" %}
                        </h5>
                        <div class="chart-controls">
                            <select class="form-select form-select-sm" id="expensesPeriod">
                                <option value="6m" selected>√öltimos 6 meses</option>
                                <option value="12m">√öltimos 12 meses</option>
                                <option value="24m">√öltimos 24 meses</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4 pt-2">
                    <canvas id="expensesChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- M√©todos de Pagamento -->
        <div class="col-lg-4" data-aos="fade-up" data-aos-delay="100">
            <div class="payment-methods-card h-100">
                <div class="card-header bg-transparent border-0 p-4 pb-2">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-credit-card me-2 text-success"></i>
                        {% trans "M√©todos de Pagamento" %}
                    </h5>
                </div>
                <div class="card-body p-4 pt-2">
                    <div class="payment-methods-list">
                        {% for method in payment_methods %}
                        <div class="payment-method-item d-flex align-items-center mb-3 p-3 border rounded">
                            <div class="payment-method-icon bg-{{ method.color }} text-white me-3">
                                <i class="{{ method.icon }}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">{{ method.name }}</div>
                                <small class="text-muted">{{ method.details }}</small>
                            </div>
                            {% if method.is_default %}
                            <span class="badge bg-success">Principal</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>
                            Adicionar M√©todo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- A√ß√µes R√°pidas -->
    <div class="mb-5">
        <h2 class="section-title" data-aos="fade-up">
            <i class="fas fa-bolt me-2 text-primary"></i>
            {% trans "A√ß√µes R√°pidas" %}
        </h2>
        <div class="row g-4" data-aos="fade-up" data-aos-delay="100">
            <div class="col-md-3">
                <div class="quick-action-card text-center p-4">
                    <div class="quick-action-icon bg-gradient-primary text-white mx-auto mb-3">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <h6 class="mb-2">{% trans "Solicitar Nota Fiscal" %}</h6>
                    <p class="text-muted mb-3 small">Gere suas notas fiscais</p>
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>
                        Solicitar
                    </button>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="quick-action-card text-center p-4">
                    <div class="quick-action-icon bg-gradient-success text-white mx-auto mb-3">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <h6 class="mb-2">{% trans "Atualizar Pagamento" %}</h6>
                    <p class="text-muted mb-3 small">Altere seu m√©todo de pagamento</p>
                    <button class="btn btn-outline-success btn-sm">
                        <i class="fas fa-edit me-1"></i>
                        Atualizar
                    </button>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="quick-action-card text-center p-4">
                    <div class="quick-action-icon bg-gradient-info text-white mx-auto mb-3">
                        <i class="fas fa-download"></i>
                    </div>
                    <h6 class="mb-2">{% trans "Baixar Comprovantes" %}</h6>
                    <p class="text-muted mb-3 small">Acesse todos os documentos</p>
                    <button class="btn btn-outline-info btn-sm">
                        <i class="fas fa-folder-open me-1"></i>
                        Acessar
                    </button>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="quick-action-card text-center p-4">
                    <div class="quick-action-icon bg-gradient-warning text-white mx-auto mb-3">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h6 class="mb-2">{% trans "Suporte Financeiro" %}</h6>
                    <p class="text-muted mb-3 small">D√∫vidas sobre cobran√ßa?</p>
                    <a href="{% url 'administration:support_page' %}" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-life-ring me-1"></i>
                        Contatar
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
.plan-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 2px solid #e9ecef;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.plan-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.plan-card.current {
    border-color: #198754;
    background: linear-gradient(135deg, #f8fff9 0%, #f0fff4 100%);
}

.plan-card.popular {
    border-color: #ffc107;
    background: linear-gradient(135deg, #fffdf7 0%, #fff8e1 100%);
}

.plan-badge {
    position: absolute;
    top: 20px;
    right: -30px;
    transform: rotate(45deg);
    z-index: 10;
}

.plan-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.billing-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.billing-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.billing-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin-bottom: 16px;
}

.invoice-table-card, .chart-card, .payment-methods-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.invoice-table-card:hover, .chart-card:hover, .payment-methods-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.invoice-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.payment-method-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.quick-action-card {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.quick-action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.quick-action-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.section-title {
    font-weight: 700;
    color: #212529;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #198754 0%, #146c43 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);
}

.bg-gradient-danger {
    background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gr√°fico de gastos
const expensesCtx = document.getElementById('expensesChart').getContext('2d');
const expensesChart = new Chart(expensesCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
        datasets: [{
            label: 'Valor Pago (R$)',
            data: [850, 920, 850, 1100, 950, 850],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#0d6efd',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'R$ ' + value;
                    }
                }
            }
        }
    }
});

function changePlan(planId) {
    if (confirm('Deseja realmente alterar seu plano? A altera√ß√£o ser√° aplicada na pr√≥xima fatura.')) {
        alert('Plano alterado com sucesso!');
        // Aqui faria a requisi√ß√£o para alterar o plano
    }
}

function downloadInvoice(invoiceId) {
    alert('Baixando fatura: ' + invoiceId);
    // Aqui faria o download da fatura
}

function viewInvoice(invoiceId) {
    alert('Visualizando fatura: ' + invoiceId);
    // Aqui abriria modal ou nova p√°gina com a fatura
}

function payInvoice(invoiceId) {
    if (confirm('Deseja pagar esta fatura agora?')) {
        alert('Redirecionando para pagamento...');
        // Aqui redirecionaria para gateway de pagamento
    }
}

// Atualizar gr√°fico quando mudar per√≠odo
document.getElementById('expensesPeriod').addEventListener('change', function() {
    console.log('Per√≠odo alterado para:', this.value);
    // Aqui faria requisi√ß√£o AJAX para novos dados
});
</script>
{% endblock %}
