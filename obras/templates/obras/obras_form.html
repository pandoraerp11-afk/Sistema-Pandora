{% extends "pandora_form_ultra_modern.html" %}

{% block title %}{% if object %}Editar Obra{% else %}Nova Obra{% endif %} - Pandora ERP{% endblock %}

{% block page_title %}
    {% if object %}Editar Obra{% else %}Nova Obra{% endif %}
{% endblock %}

{% block page_subtitle %}
    {{ subtitulo|default:"Preencha os dados para cadastrar a obra" }}
{% endblock %}

{% block form_title %}Informações da Obra{% endblock %}

{% block form_content %}
<div class="container-fluid py-4">
    {# Mensagens do Django #}
    {% if messages %}
        {% for message in messages %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" data-aos="fade-up">
                        <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm" data-aos="fade-up">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" novalidate id="obraForm">
                        {% csrf_token %}

                        <div class="row g-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Identificação
                                </h5>
                            </div>

                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="{{ form.nome.id_for_label }}" class="form-label">
                                        <i class="fas fa-signature text-primary"></i>
                                        Nome da Obra <span class="text-danger">*</span>
                                    </label>
                                    {{ form.nome }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.tipo_obra.id_for_label }}" class="form-label">
                                        <i class="fas fa-layer-group text-primary"></i>
                                        Tipo de Obra
                                    </label>
                                    {{ form.tipo_obra }}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.cno.id_for_label }}" class="form-label">
                                        <i class="fas fa-hashtag text-primary"></i>
                                        CNO
                                    </label>
                                    {{ form.cno }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.cliente.id_for_label }}" class="form-label">
                                        <i class="fas fa-user text-primary"></i>
                                        Cliente
                                    </label>
                                    {{ form.cliente }}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row g-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-map-marked-alt me-2"></i>
                                    Localização
                                </h5>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.cep.id_for_label }}" class="form-label">CEP</label>
                                    {{ form.cep }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.endereco.id_for_label }}" class="form-label">Endereço</label>
                                    {{ form.endereco }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.cidade.id_for_label }}" class="form-label">Cidade</label>
                                    {{ form.cidade }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.estado.id_for_label }}" class="form-label">Estado</label>
                                    {{ form.estado }}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row g-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Cronograma e Status
                                </h5>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.data_inicio.id_for_label }}" class="form-label">Data de Início</label>
                                    {{ form.data_inicio }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.data_previsao_termino.id_for_label }}" class="form-label">Previsão de Término</label>
                                    {{ form.data_previsao_termino }}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.data_termino.id_for_label }}" class="form-label">Data de Término</label>
                                    {{ form.data_termino }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                                    {{ form.status }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.progresso.id_for_label }}" class="form-label">Progresso</label>
                                    {{ form.progresso }}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row g-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    Valores
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.valor_contrato.id_for_label }}" class="form-label">Valor do Contrato</label>
                                    {{ form.valor_contrato }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.valor_total.id_for_label }}" class="form-label">Valor Total</label>
                                    {{ form.valor_total }}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row g-4">
                            <div class="col-12">
                                <h5 class="fw-bold text-primary mb-3">
                                    <i class="fas fa-sticky-note me-2"></i>
                                    Observações
                                </h5>
                            </div>
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observações</label>
                                    {{ form.observacoes }}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-3 justify-content-end mt-4">
                            <a href="{% url 'obras:obras_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-1"></i> Salvar Obra
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm" data-aos="fade-up" data-aos-delay="200">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">
                        <i class="fas fa-eye me-2"></i>
                        Preview da Obra
                    </h6>
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3">
                                    <div class="d-flex align-items-center justify-content-center bg-primary text-white rounded-3 fs-5" style="width: 50px; height: 50px;">
                                        <i class="fas fa-hard-hat"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-bold" id="previewNome">{% if object %}{{ object.nome }}{% else %}Nome da Obra{% endif %}</div>
                                    <div class="text-muted small" id="previewCliente">Cliente: {% if object and object.cliente %}{{ object.cliente }}{% else %}não definido{% endif %}</div>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fw-bold text-primary" id="previewStatus">{% if object and object.get_status_display %}{{ object.get_status_display }}{% else %}Sem status{% endif %}</div>
                                    <div class="small text-muted">Status</div>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold text-success" id="previewProgresso">{% if object and object.progresso %}{{ object.progresso }}%{% else %}0%{% endif %}</div>
                                    <div class="small text-muted">Progresso</div>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-top text-center">
                                <div class="fw-bold" id="previewValor">Valor: R$ {% if object and object.valor_contrato %}{{ object.valor_contrato|floatformat:2 }}{% else %}0,00{% endif %}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mt-3" data-aos="fade-up" data-aos-delay="300">
                <div class="card-body">
                    <h6 class="card-title fw-bold mb-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        Dicas
                    </h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i><small>Informe um nome claro e identifique o cliente corretamente.</small></li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i><small>Preencha as datas para melhor acompanhamento.</small></li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i><small>Atualize o status e progresso sempre que houver mudanças.</small></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('obraForm');
    const submitBtn = document.getElementById('submitBtn');
    if (form && submitBtn) {
        form.addEventListener('submit', function() {
            const original = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            submitBtn.disabled = true;
            setTimeout(() => { submitBtn.innerHTML = original; submitBtn.disabled = false; }, 5000);
        });
    }

    function byId(id){return document.getElementById(id);}    
    function updatePreview(){
        const nome = byId('{{ form.nome.id_for_label }}');
        const cliente = byId('{{ form.cliente.id_for_label }}');
        const status = byId('{{ form.status.id_for_label }}');
        const progresso = byId('{{ form.progresso.id_for_label }}');
        const valor = byId('{{ form.valor_contrato.id_for_label }}');
        if (nome) byId('previewNome').textContent = nome.value || 'Nome da Obra';
        if (cliente) byId('previewCliente').textContent = 'Cliente: ' + (cliente.options ? (cliente.options[cliente.selectedIndex]?.text || 'não definido') : (cliente.value || 'não definido'));
        if (status) byId('previewStatus').textContent = status.options ? (status.options[status.selectedIndex]?.text || 'Sem status') : (status.value || 'Sem status');
        if (progresso) byId('previewProgresso').textContent = (progresso.value ? progresso.value + '%' : '0%');
        if (valor) byId('previewValor').textContent = 'Valor: R$ ' + (valor.value || '0,00');
    }

    ['{{ form.nome.id_for_label }}','{{ form.cliente.id_for_label }}','{{ form.status.id_for_label }}','{{ form.progresso.id_for_label }}','{{ form.valor_contrato.id_for_label }}']
    .forEach(function(id){ const el=document.getElementById(id); if(el){ el.addEventListener('input', updatePreview); el.addEventListener('change', updatePreview);} });
    updatePreview();
});
</script>
{% endblock %}
