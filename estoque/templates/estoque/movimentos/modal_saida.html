{% load widget_tweaks %}

<!-- Modal para Saída de Estoque -->
<div class="modal fade" id="modalSaida" tabindex="-1" aria-labelledby="modalSaidaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalSaidaLabel">
                    <i class="fas fa-arrow-down me-2"></i>Nova Saída de Estoque
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <form id="formSaida" data-url="{% url 'estoque:movimento_saida' %}">
                    {% csrf_token %}
                    
                    <!-- Tipo de Saída -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_tipo_saida" class="form-label">
                                <i class="fas fa-list me-1"></i>Tipo de Saída *
                            </label>
                            <select name="tipo_saida" id="id_tipo_saida" class="form-select" required>
                                <option value="">Selecione o tipo...</option>
                                <option value="VENDA">Venda</option>
                                <option value="CONSUMO">Consumo Interno</option>
                                <option value="PRODUCAO">Produção</option>
                                <option value="DEVOLUCAO">Devolução</option>
                                <option value="PERDA">Perda</option>
                                <option value="DESCARTE">Descarte</option>
                                <option value="TRANSFERENCIA_INTERNA">Transferência Interna</option>
                                <option value="OUTRO">Outro</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="id_prioridade" class="form-label">
                                <i class="fas fa-flag me-1"></i>Prioridade
                            </label>
                            <select name="prioridade" id="id_prioridade" class="form-select">
                                <option value="NORMAL">Normal</option>
                                <option value="ALTA">Alta</option>
                                <option value="URGENTE">Urgente</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Produto e Lote -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="id_produto_saida" class="form-label">
                                <i class="fas fa-cube me-1"></i>Produto *
                            </label>
                            <select name="produto" id="id_produto_saida" class="form-select produto-select" required>
                                <option value="">Selecione um produto...</option>
                            </select>
                            <div class="form-text">
                                Digite para pesquisar por nome ou código do produto
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="id_lote_saida" class="form-label">
                                <i class="fas fa-barcode me-1"></i>Lote
                            </label>
                            <select name="lote" id="id_lote_saida" class="form-select" disabled>
                                <option value="">Selecione primeiro o produto</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Informações do Produto Selecionado -->
                    <div id="produto-info-saida" class="alert alert-info d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <strong id="produto-nome-saida"></strong>
                                <br><small class="text-muted" id="produto-codigo-saida"></small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="fw-semibold">Estoque Disponível</div>
                                <div class="fs-4 text-primary" id="produto-estoque-saida">0</div>
                                <small class="text-muted" id="produto-unidade-saida">UN</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="fw-semibold">Reservado</div>
                                <div class="fs-5 text-warning" id="produto-reservado-saida">0</div>
                                <small class="text-muted">Unidades</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alerta de Estoque Baixo -->
                    <div id="alerta-estoque" class="alert alert-warning d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> <span id="mensagem-estoque"></span>
                    </div>
                    
                    <!-- Quantidade e Depósito -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="id_quantidade_saida" class="form-label">
                                <i class="fas fa-hashtag me-1"></i>Quantidade *
                            </label>
                            <input type="number" name="quantidade" id="id_quantidade_saida" class="form-control" 
                                   min="0.01" step="0.01" required>
                            <div id="estoque-apos" class="form-text text-muted"></div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="id_custo_unitario_saida" class="form-label">
                                <i class="fas fa-dollar-sign me-1"></i>Custo Unitário
                            </label>
                            <input type="number" name="custo_unitario" id="id_custo_unitario_saida" class="form-control" 
                                   min="0" step="0.01" readonly>
                            <div class="form-text">
                                Custo médio atual do produto
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="id_deposito_saida" class="form-label">
                                <i class="fas fa-warehouse me-1"></i>Depósito *
                            </label>
                            <select name="deposito" id="id_deposito_saida" class="form-select" required>
                                <option value="">Selecione um depósito...</option>
                                {% for deposito in depositos %}
                                    <option value="{{ deposito.id }}">{{ deposito.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Destinatário/Solicitante -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_destinatario" class="form-label">
                                <i class="fas fa-user me-1"></i>Destinatário/Cliente
                            </label>
                            <input type="text" name="destinatario_nome" id="id_destinatario" class="form-control" 
                                   placeholder="Nome do destinatário ou cliente">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="id_solicitante_saida" class="form-label">
                                <i class="fas fa-user-tie me-1"></i>Solicitante
                            </label>
                            <input type="text" name="solicitante_nome" id="id_solicitante_saida" class="form-control" 
                                   placeholder="Nome do solicitante" value="{{ request.user.get_full_name }}">
                        </div>
                    </div>
                    
                    <!-- Referência Externa e Centro de Custo -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_ref_externa_saida" class="form-label">
                                <i class="fas fa-link me-1"></i>Referência Externa
                            </label>
                            <input type="text" name="ref_externa" id="id_ref_externa_saida" class="form-control" 
                                   placeholder="Ex: Pedido de Venda, OS, NF...">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="id_centro_custo" class="form-label">
                                <i class="fas fa-building me-1"></i>Centro de Custo
                            </label>
                            <select name="centro_custo" id="id_centro_custo" class="form-select">
                                <option value="">Selecione o centro de custo...</option>
                                {% for cc in centros_custo %}
                                    <option value="{{ cc.id }}">{{ cc.codigo }} - {{ cc.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Motivo da Saída -->
                    <div class="mb-3">
                        <label for="id_motivo" class="form-label">
                            <i class="fas fa-comment-alt me-1"></i>Motivo da Saída *
                        </label>
                        <textarea name="motivo" id="id_motivo" class="form-control" rows="2" required
                                placeholder="Descreva brevemente o motivo da saída..."></textarea>
                    </div>
                    
                    <!-- Observações -->
                    <div class="mb-3">
                        <label for="id_observacoes_saida" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Observações
                        </label>
                        <textarea name="observacoes" id="id_observacoes_saida" class="form-control" 
                                rows="3" placeholder="Informações adicionais sobre a saída..."></textarea>
                    </div>
                    
                    <!-- Opções Avançadas -->
                    <div class="card border-secondary">
                        <div class="card-header">
                            <button class="btn btn-link p-0 text-decoration-none" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#opcoes-avancadas" 
                                    aria-expanded="false">
                                <i class="fas fa-cog me-1"></i>Opções Avançadas
                                <i class="fas fa-chevron-down float-end"></i>
                            </button>
                        </div>
                        <div class="collapse" id="opcoes-avancadas">
                            <div class="card-body">
                                <!-- Agendamento -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="agendar_saida" 
                                                   id="id_agendar_saida">
                                            <label class="form-check-label" for="id_agendar_saida">
                                                <i class="fas fa-calendar-alt me-1"></i>Agendar saída para data específica
                                            </label>
                                        </div>
                                        
                                        <input type="datetime-local" name="data_agendada" id="id_data_agendada" 
                                               class="form-control mt-2" disabled>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="notificar_baixo_estoque" 
                                                   id="id_notificar_baixo_estoque" checked>
                                            <label class="form-check-label" for="id_notificar_baixo_estoque">
                                                Notificar se estoque ficar baixo
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="criar_reserva_automatica" 
                                                   id="id_criar_reserva">
                                            <label class="form-check-label" for="id_criar_reserva">
                                                Criar reserva automática
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Evidências -->
                    <div class="mb-3 mt-3">
                        <label for="id_evidencias_saida" class="form-label">
                            <i class="fas fa-paperclip me-1"></i>Evidências (Anexos)
                        </label>
                        <input type="file" name="evidencias" id="id_evidencias_saida" class="form-control" 
                               multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
                        <div class="form-text">
                            Opcional - anexe comprovantes, autorizações ou documentos
                        </div>
                        
                        <div id="preview-evidencias-saida" class="mt-2"></div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-warning" onclick="processarSaida('rascunho')">
                        <i class="fas fa-save me-1"></i>Salvar Rascunho
                    </button>
                    
                    <button type="button" class="btn btn-danger" onclick="processarSaida('processar')">
                        <i class="fas fa-check me-1"></i>Processar Saída
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos específicos para modal de saída */
#produto-info-saida {
    border-left: 4px solid #dc3545;
}

.estoque-critico {
    color: #dc3545 !important;
    font-weight: bold;
}

.estoque-baixo {
    color: #fd7e14 !important;
    font-weight: bold;
}

.quantidade-excedente {
    border-color: #dc3545 !important;
    background-color: #f8d7da !important;
}

.prioridade-alta {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
}

.prioridade-urgente {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
    100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicialização do Select2 para produtos na saída
    $('#id_produto_saida').select2({
        dropdownParent: $('#modalSaida'),
        ajax: {
            url: '{% url "estoque:api_produtos_com_estoque" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    search: params.term,
                    page: params.page,
                    com_estoque: true
                };
            },
            processResults: function (data, params) {
                params.page = params.page || 1;
                return {
                    results: data.results.map(item => ({
                        id: item.id,
                        text: `${item.nome} (${item.codigo || 'S/C'}) - Est: ${item.estoque_atual}`,
                        produto: item
                    })),
                    pagination: {
                        more: data.next !== null
                    }
                };
            }
        },
        placeholder: 'Digite para pesquisar produtos com estoque...',
        minimumInputLength: 2
    });
    
    // Evento ao selecionar produto
    $('#id_produto_saida').on('select2:select', function (e) {
        const produto = e.params.data.produto;
        mostrarInfoProdutoSaida(produto);
        carregarLotes(produto.id);
        verificarEstoque(produto);
    });
    
    // Eventos de validação
    $('#id_quantidade_saida').on('input', function() {
        validarQuantidadeSaida();
        calcularEstoqueApos();
    });
    
    // Agendamento
    $('#id_agendar_saida').on('change', function() {
        $('#id_data_agendada').prop('disabled', !this.checked);
        if (this.checked) {
            // Definir data mínima como agora
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            $('#id_data_agendada').attr('min', now.toISOString().slice(0, 16));
        }
    });
    
    // Preview de evidências
    $('#id_evidencias_saida').on('change', function() {
        previewEvidenciasSaida(this.files);
    });
    
    // Mudança no tipo de saída
    $('#id_tipo_saida').on('change', function() {
        ajustarCamposPorTipo(this.value);
    });
});

function mostrarInfoProdutoSaida(produto) {
    $('#produto-nome-saida').text(produto.nome);
    $('#produto-codigo-saida').text(produto.codigo || 'Sem código');
    $('#produto-estoque-saida').text(produto.estoque_atual || 0);
    $('#produto-reservado-saida').text(produto.estoque_reservado || 0);
    $('#produto-unidade-saida').text(produto.unidade_medida || 'UN');
    
    $('#produto-info-saida').removeClass('d-none');
    
    // Preencher custo médio
    if (produto.custo_medio) {
        $('#id_custo_unitario_saida').val(produto.custo_medio.toFixed(2));
    }
    
    // Definir quantidade máxima
    const estoqueDisponivel = produto.estoque_atual - (produto.estoque_reservado || 0);
    $('#id_quantidade_saida').attr('max', estoqueDisponivel);
}

function carregarLotes(produtoId) {
    $('#id_lote_saida').prop('disabled', true).html('<option value="">Carregando lotes...</option>');
    
    fetch(`{% url 'estoque:api_lotes_produto' 0 %}`.replace('0', produtoId))
        .then(response => response.json())
        .then(data => {
            const select = $('#id_lote_saida');
            select.html('<option value="">Todos os lotes</option>');
            
            if (data.results && data.results.length > 0) {
                data.results.forEach(lote => {
                    const option = new Option(
                        `${lote.codigo} (Qtd: ${lote.quantidade_disponivel})`,
                        lote.id
                    );
                    select.append(option);
                });
                select.prop('disabled', false);
            } else {
                select.html('<option value="">Produto sem lotes</option>');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar lotes:', error);
            $('#id_lote_saida').html('<option value="">Erro ao carregar lotes</option>');
        });
}

function verificarEstoque(produto) {
    const estoqueDisponivel = produto.estoque_atual - (produto.estoque_reservado || 0);
    const estoqueMinimo = produto.estoque_minimo || 0;
    
    if (estoqueDisponivel <= 0) {
        mostrarAlertaEstoque('danger', 'Produto sem estoque disponível!');
        $('#produto-estoque-saida').addClass('estoque-critico');
    } else if (estoqueDisponivel <= estoqueMinimo) {
        mostrarAlertaEstoque('warning', 'Produto com estoque baixo. Considere repor antes da saída.');
        $('#produto-estoque-saida').addClass('estoque-baixo');
    } else {
        esconderAlertaEstoque();
        $('#produto-estoque-saida').removeClass('estoque-critico estoque-baixo');
    }
}

function mostrarAlertaEstoque(tipo, mensagem) {
    const alerta = $('#alerta-estoque');
    alerta.removeClass('alert-warning alert-danger')
          .addClass(`alert-${tipo}`)
          .removeClass('d-none');
    $('#mensagem-estoque').text(mensagem);
}

function esconderAlertaEstoque() {
    $('#alerta-estoque').addClass('d-none');
}

function validarQuantidadeSaida() {
    const quantidade = parseFloat($('#id_quantidade_saida').val()) || 0;
    const estoqueDisponivel = parseFloat($('#produto-estoque-saida').text()) - 
                             parseFloat($('#produto-reservado-saida').text());
    
    if (quantidade > estoqueDisponivel) {
        $('#id_quantidade_saida').addClass('quantidade-excedente is-invalid');
        
        if (!$('#error-quantidade').length) {
            $('#id_quantidade_saida').after(`
                <div id="error-quantidade" class="invalid-feedback">
                    Quantidade superior ao estoque disponível (${estoqueDisponivel})
                </div>
            `);
        }
        return false;
    } else {
        $('#id_quantidade_saida').removeClass('quantidade-excedente is-invalid');
        $('#error-quantidade').remove();
        return true;
    }
}

function calcularEstoqueApos() {
    const quantidade = parseFloat($('#id_quantidade_saida').val()) || 0;
    const estoqueAtual = parseFloat($('#produto-estoque-saida').text()) || 0;
    const estoqueApos = estoqueAtual - quantidade;
    
    if (quantidade > 0) {
        let classe = estoqueApos < 0 ? 'text-danger' : 
                    estoqueApos === 0 ? 'text-warning' : 'text-success';
        
        $('#estoque-apos').html(`
            <i class="fas fa-info-circle me-1"></i>
            Estoque após saída: <span class="${classe}">${estoqueApos.toFixed(0)}</span>
        `);
    } else {
        $('#estoque-apos').empty();
    }
}

function ajustarCamposPorTipo(tipo) {
    // Ajustar campos específicos por tipo de saída
    switch(tipo) {
        case 'VENDA':
            $('#id_destinatario').attr('placeholder', 'Nome do cliente');
            $('#id_centro_custo').closest('.col-md-6').show();
            break;
        case 'CONSUMO':
        case 'PRODUCAO':
            $('#id_destinatario').attr('placeholder', 'Setor ou departamento');
            $('#id_centro_custo').closest('.col-md-6').show();
            break;
        case 'PERDA':
        case 'DESCARTE':
            $('#id_destinatario').attr('placeholder', 'Local de descarte');
            $('#id_motivo').attr('placeholder', 'Descreva detalhadamente o motivo da perda/descarte...');
            break;
        default:
            $('#id_destinatario').attr('placeholder', 'Destinatário');
    }
}

function previewEvidenciasSaida(files) {
    const preview = $('#preview-evidencias-saida');
    preview.empty();
    
    Array.from(files).forEach(file => {
        const div = $('<div class="preview-file"></div>');
        
        if (file.type.startsWith('image/')) {
            const img = $('<img>');
            img.attr('src', URL.createObjectURL(file));
            img.attr('alt', file.name);
            div.append(img);
        } else {
            div.html(`
                <i class="fas fa-file-alt fa-2x text-muted"></i>
                <br><small>${file.name}</small>
            `);
        }
        
        const removeBtn = $('<button type="button" class="btn btn-sm btn-danger mt-1">×</button>');
        removeBtn.on('click', function() {
            div.remove();
        });
        
        div.append(removeBtn);
        preview.append(div);
    });
}

function processarSaida(acao) {
    const form = $('#formSaida');
    const formData = new FormData(form[0]);
    
    // Validações específicas
    if (!validarQuantidadeSaida()) {
        mostrarMensagem('error', 'Corrija os erros no formulário antes de continuar');
        return;
    }
    
    // Adicionar ação
    formData.append('acao', acao);
    
    // Validação básica
    if (!form[0].checkValidity()) {
        form[0].reportValidity();
        return;
    }
    
    // Confirmação para ações críticas
    if (acao === 'processar') {
        const quantidade = $('#id_quantidade_saida').val();
        const produto = $('#produto-nome-saida').text();
        
        if (!confirm(`Confirma a saída de ${quantidade} unidades de ${produto}?`)) {
            return;
        }
    }
    
    // Mostrar loading
    mostrarLoadingSaida();
    
    // Enviar dados
    fetch(form.data('url'), {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        esconderLoadingSaida();
        
        if (data.success) {
            $('#modalSaida').modal('hide');
            mostrarMensagem('success', data.message);
            
            if (typeof recarregarMovimentos === 'function') {
                recarregarMovimentos();
            }
            
            limparFormularioSaida();
            
        } else {
            mostrarMensagem('error', data.message || 'Erro ao processar saída');
            
            if (data.errors) {
                Object.keys(data.errors).forEach(field => {
                    const input = form.find(`[name="${field}"]`);
                    input.addClass('is-invalid');
                    input.siblings('.invalid-feedback').remove();
                    input.after(`<div class="invalid-feedback">${data.errors[field].join(', ')}</div>`);
                });
            }
        }
    })
    .catch(error => {
        esconderLoadingSaida();
        console.error('Erro:', error);
        mostrarMensagem('error', 'Erro interno do sistema');
    });
}

function mostrarLoadingSaida() {
    $('.modal-content').append(`
        <div class="loading-overlay">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Processando saída...</span>
            </div>
        </div>
    `);
}

function esconderLoadingSaida() {
    $('.loading-overlay').remove();
}

function limparFormularioSaida() {
    $('#formSaida')[0].reset();
    $('#id_produto_saida').val(null).trigger('change');
    $('#produto-info-saida').addClass('d-none');
    $('#alerta-estoque').addClass('d-none');
    $('#preview-evidencias-saida').empty();
    $('#estoque-apos').empty();
    $('#error-quantidade').remove();
    $('.is-invalid').removeClass('is-invalid');
    $('.invalid-feedback').remove();
}

// Limpar formulário ao fechar modal
$('#modalSaida').on('hidden.bs.modal', function() {
    limparFormularioSaida();
});
</script>
