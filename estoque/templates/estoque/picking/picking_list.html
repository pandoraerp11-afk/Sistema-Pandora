{% extends "pandora_list_ultra_modern.html" %}
{% load static %}
{% load i18n %}

{# Título e configurações da página #}
{% block title %}Sistema de Picking - Estoque{% endblock %}

{# Header da lista #}
{% block list_icon %}<i class="fas fa-shipping-fast me-2 text-info"></i>{% endblock %}
{% block list_title %}Sistema de Picking{% endblock %}
{% block list_subtitle %}Gerenciamento completo de separação e conferência de pedidos{% endblock %}

{# Botões de ação no header #}
{% block list_header_actions %}
    <a href="{% url 'estoque:picking_add' %}" class="btn btn-gradient-info me-2" data-bs-toggle="tooltip" title="Novo Picking">
        <i class="fas fa-plus me-1"></i>Novo Picking
    </a>
    <a href="{% url 'estoque:picking_relatorio' %}" class="btn btn-gradient-success me-2" data-bs-toggle="tooltip" title="Relatório">
        <i class="fas fa-chart-bar me-1"></i>Relatório
    </a>
    <a href="{% url 'estoque:estoque_home' %}" class="btn btn-gradient-secondary" data-bs-toggle="tooltip" title="Voltar ao Home">
        <i class="fas fa-home me-1"></i>Home
    </a>
{% endblock %}

{# Filtros personalizados #}
{% block list_filters %}
    <div class="filter-card" data-aos="fade-up">
        <div class="card-body">
            <form method="get" class="row g-3" id="filtros-picking">
                <div class="col-md-3">
                    <label for="status" class="form-label fw-semibold">Status</label>
                    <select class="form-select form-select-modern" name="status" id="status">
                        <option value="">Todos os status</option>
                        <option value="PENDENTE" {% if request.GET.status == "PENDENTE" %}selected{% endif %}>Pendente</option>
                        <option value="EM_SEPARACAO" {% if request.GET.status == "EM_SEPARACAO" %}selected{% endif %}>Em Separação</option>
                        <option value="SEPARADO" {% if request.GET.status == "SEPARADO" %}selected{% endif %}>Separado</option>
                        <option value="CONFERIDO" {% if request.GET.status == "CONFERIDO" %}selected{% endif %}>Conferido</option>
                        <option value="FINALIZADO" {% if request.GET.status == "FINALIZADO" %}selected{% endif %}>Finalizado</option>
                        <option value="CANCELADO" {% if request.GET.status == "CANCELADO" %}selected{% endif %}>Cancelado</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="prioridade" class="form-label fw-semibold">Prioridade</label>
                    <select class="form-select form-select-modern" name="prioridade" id="prioridade">
                        <option value="">Todas</option>
                        <option value="BAIXA" {% if request.GET.prioridade == "BAIXA" %}selected{% endif %}>Baixa</option>
                        <option value="NORMAL" {% if request.GET.prioridade == "NORMAL" %}selected{% endif %}>Normal</option>
                        <option value="ALTA" {% if request.GET.prioridade == "ALTA" %}selected{% endif %}>Alta</option>
                        <option value="URGENTE" {% if request.GET.prioridade == "URGENTE" %}selected{% endif %}>Urgente</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="responsavel" class="form-label fw-semibold">Responsável</label>
                    <select class="form-select form-select-modern" name="responsavel" id="responsavel">
                        <option value="">Todos</option>
                        {% for user in responsaveis %}
                            <option value="{{ user.id }}" {% if request.GET.responsavel == user.id|stringformat:"s" %}selected{% endif %}>
                                {{ user.get_full_name|default:user.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="deposito" class="form-label fw-semibold">Depósito</label>
                    <select class="form-select form-select-modern" name="deposito" id="deposito">
                        <option value="">Todos</option>
                        {% for deposito in depositos %}
                            <option value="{{ deposito.id }}" {% if request.GET.deposito == deposito.id|stringformat:"s" %}selected{% endif %}>
                                {{ deposito.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-12 d-flex gap-2">
                    <button type="submit" class="btn btn-gradient-primary">
                        <i class="fas fa-search me-1"></i>Filtrar
                    </button>
                    <a href="{% url 'estoque:picking_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Limpar
                    </a>
                    <button type="button" class="btn btn-gradient-success" onclick="exportarPicking()">
                        <i class="fas fa-file-excel me-1"></i>Exportar
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{# Cards de resumo #}
{% block list_summary %}
    <div class="row g-3 mb-4" data-aos="fade-up" data-aos-delay="100">
        <div class="col-lg-3 col-md-6">
            <div class="summary-card bg-gradient-warning">
                <div class="summary-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-content">
                    <h3>{{ resumo.pendentes|default:0 }}</h3>
                    <p>Pendentes</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-card bg-gradient-info">
                <div class="summary-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="summary-content">
                    <h3>{{ resumo.em_separacao|default:0 }}</h3>
                    <p>Em Separação</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-card bg-gradient-success">
                <div class="summary-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <h3>{{ resumo.finalizados_hoje|default:0 }}</h3>
                    <p>Finalizados Hoje</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="summary-card bg-gradient-primary">
                <div class="summary-icon">
                    <i class="fas fa-shipping-fast"></i>
                </div>
                <div class="summary-content">
                    <h3>{{ resumo.total_mes|default:0 }}</h3>
                    <p>Total do Mês</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{# Tabela de dados #}
{% block list_table %}
    <div class="table-card" data-aos="fade-up" data-aos-delay="200">
        <div class="table-responsive">
            <table class="table table-modern" id="picking-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="codigo">
                            <i class="fas fa-hashtag me-1"></i>Código
                            <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable" data-sort="pedido">
                            <i class="fas fa-shopping-cart me-1"></i>Pedido
                            <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable text-center" data-sort="itens">
                            <i class="fas fa-list me-1"></i>Itens
                            <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable" data-sort="responsavel">
                            <i class="fas fa-user me-1"></i>Responsável
                            <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable text-center" data-sort="prioridade">
                            <i class="fas fa-flag me-1"></i>Prioridade
                            <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable text-center" data-sort="data_criacao">
                            <i class="fas fa-calendar me-1"></i>Criação
                            <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Progresso</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for picking in pickings %}
                        <tr class="{% if picking.prioridade == 'URGENTE' %}table-danger{% elif picking.prioridade == 'ALTA' %}table-warning{% endif %}">
                            <td>
                                <strong class="text-primary">#{{ picking.codigo }}</strong>
                                {% if picking.prioridade in 'ALTA,URGENTE' %}
                                    <span class="badge bg-{% if picking.prioridade == 'URGENTE' %}danger{% else %}warning{% endif %} ms-2">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="fas fa-shopping-cart text-muted"></i>
                                    </div>
                                    <div>
                                        {% if picking.pedido %}
                                            <strong>#{{ picking.pedido.numero }}</strong><br>
                                            <small class="text-muted">{{ picking.pedido.cliente.nome|truncatechars:20 }}</small>
                                        {% else %}
                                            <strong>Picking Avulso</strong><br>
                                            <small class="text-muted">{{ picking.observacoes|truncatechars:20|default:"—" }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge-quantity">{{ picking.total_itens }}</span>
                                <br><small class="text-muted">{{ picking.total_quantidade|floatformat:0 }} und.</small>
                            </td>
                            <td>
                                {% if picking.responsavel %}
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-2">
                                            {% if picking.responsavel.profile.avatar %}
                                                <img src="{{ picking.responsavel.profile.avatar.url }}" class="rounded-circle" width="24" height="24">
                                            {% else %}
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 24px; height: 24px; font-size: 12px;">
                                                    {{ picking.responsavel.first_name.0|default:picking.responsavel.username.0|upper }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <small class="fw-semibold">{{ picking.responsavel.get_full_name|default:picking.responsavel.username }}</small>
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-muted">Não atribuído</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if picking.prioridade == 'BAIXA' %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-arrow-down me-1"></i>Baixa
                                    </span>
                                {% elif picking.prioridade == 'NORMAL' %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-minus me-1"></i>Normal
                                    </span>
                                {% elif picking.prioridade == 'ALTA' %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-arrow-up me-1"></i>Alta
                                    </span>
                                {% elif picking.prioridade == 'URGENTE' %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Urgente
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div>{{ picking.data_criacao|date:"d/m/Y" }}</div>
                                <small class="text-muted">{{ picking.data_criacao|time:"H:i" }}</small>
                            </td>
                            <td class="text-center">
                                {% if picking.status == 'PENDENTE' %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>Pendente
                                    </span>
                                {% elif picking.status == 'EM_SEPARACAO' %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-cog me-1 fa-spin"></i>Em Separação
                                    </span>
                                {% elif picking.status == 'SEPARADO' %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-check me-1"></i>Separado
                                    </span>
                                {% elif picking.status == 'CONFERIDO' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-double me-1"></i>Conferido
                                    </span>
                                {% elif picking.status == 'FINALIZADO' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-flag-checkered me-1"></i>Finalizado
                                    </span>
                                {% elif picking.status == 'CANCELADO' %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-ban me-1"></i>Cancelado
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="progress-container">
                                    <div class="progress progress-sm mb-1" style="height: 6px;">
                                        <div class="progress-bar 
                                            {% if picking.status == 'PENDENTE' %}bg-warning{% elif picking.status == 'EM_SEPARACAO' %}bg-info{% elif picking.status == 'SEPARADO' %}bg-primary{% elif picking.status == 'CONFERIDO' %}bg-success{% elif picking.status == 'FINALIZADO' %}bg-success{% else %}bg-secondary{% endif %}" 
                                             style="width: {{ picking.progresso_percentual }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ picking.progresso_percentual|floatformat:0 }}%</small>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'estoque:picking_detail' picking.id %}">
                                                <i class="fas fa-eye me-2"></i>Visualizar
                                            </a>
                                        </li>
                                        {% if picking.status in 'PENDENTE,EM_SEPARACAO' %}
                                            <li>
                                                <a class="dropdown-item" href="{% url 'estoque:picking_edit' picking.id %}">
                                                    <i class="fas fa-edit me-2"></i>Editar
                                                </a>
                                            </li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        {% if picking.status == 'PENDENTE' %}
                                            <li>
                                                <a class="dropdown-item text-info" href="{% url 'estoque:picking_iniciar' picking.id %}">
                                                    <i class="fas fa-play me-2"></i>Iniciar Separação
                                                </a>
                                            </li>
                                        {% elif picking.status == 'EM_SEPARACAO' %}
                                            <li>
                                                <a class="dropdown-item text-primary" href="{% url 'estoque:picking_separar' picking.id %}">
                                                    <i class="fas fa-check me-2"></i>Marcar Separado
                                                </a>
                                            </li>
                                        {% elif picking.status == 'SEPARADO' %}
                                            <li>
                                                <a class="dropdown-item text-success" href="{% url 'estoque:picking_conferir' picking.id %}">
                                                    <i class="fas fa-check-double me-2"></i>Conferir
                                                </a>
                                            </li>
                                        {% elif picking.status == 'CONFERIDO' %}
                                            <li>
                                                <a class="dropdown-item text-success" href="{% url 'estoque:picking_finalizar' picking.id %}">
                                                    <i class="fas fa-flag-checkered me-2"></i>Finalizar
                                                </a>
                                            </li>
                                        {% endif %}
                                        
                                        {% if picking.status not in 'FINALIZADO,CANCELADO' %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="{% url 'estoque:picking_cancelar' picking.id %}">
                                                    <i class="fas fa-times me-2"></i>Cancelar
                                                </a>
                                            </li>
                                        {% endif %}
                                        
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'estoque:picking_historico' picking.id %}">
                                                <i class="fas fa-history me-2"></i>Histórico
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'estoque:picking_print' picking.id %}" target="_blank">
                                                <i class="fas fa-print me-2"></i>Imprimir
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-shipping-fast fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Nenhum picking encontrado</h5>
                                    <p class="text-muted mb-3">Tente ajustar os filtros ou crie um novo picking</p>
                                    <a href="{% url 'estoque:picking_add' %}" class="btn btn-gradient-info">
                                        <i class="fas fa-plus me-1"></i>Novo Picking
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{# Scripts personalizados #}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Auto-submit do formulário de filtros
    const selects = document.querySelectorAll('#filtros-picking select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            setTimeout(() => {
                document.getElementById('filtros-picking').submit();
            }, 100);
        });
    });
    
    // Função de exportação
    window.exportarPicking = function() {
        const form = document.getElementById('filtros-picking');
        const formData = new FormData(form);
        formData.append('export', 'excel');
        
        const params = new URLSearchParams(formData);
        const downloadUrl = `{% url 'estoque:picking_export' %}?${params.toString()}`;
        
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `picking_estoque_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    // Atualização em tempo real via WebSocket
    if ('WebSocket' in window) {
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsUrl = `${protocol}${window.location.host}/ws/picking/`;
        
        try {
            const ws = new WebSocket(wsUrl);
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.event && data.event.startsWith('picking.')) {
                    // Atualizar linha específica se existir
                    if (data.picking_id) {
                        const row = document.querySelector(`tr[data-picking-id="${data.picking_id}"]`);
                        if (row) {
                            // Destacar a linha atualizada
                            row.classList.add('table-info');
                            setTimeout(() => {
                                row.classList.remove('table-info');
                            }, 3000);
                        }
                    }
                    
                    // Mostrar notificação
                    let message = '';
                    let type = 'info';
                    
                    switch(data.event) {
                        case 'picking.iniciado':
                            message = 'Picking iniciado';
                            type = 'info';
                            break;
                        case 'picking.separado':
                            message = 'Picking separado';
                            type = 'primary';
                            break;
                        case 'picking.conferido':
                            message = 'Picking conferido';
                            type = 'success';
                            break;
                        case 'picking.finalizado':
                            message = 'Picking finalizado';
                            type = 'success';
                            break;
                        case 'picking.cancelado':
                            message = 'Picking cancelado';
                            type = 'warning';
                            break;
                    }
                    
                    if (message && window.PandoraNotif) {
                        PandoraNotif.toast(`${message} - #${data.codigo || data.picking_id}`, type, 3000);
                    }
                    
                    // Recarregar após alguns segundos para mostrar mudanças
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }
            };
        } catch (error) {
            console.error('Erro ao conectar WebSocket:', error);
        }
    }
    
    // Auto-refresh a cada 5 minutos para pickings ativos
    setInterval(function() {
        const hasAtivos = document.querySelector('.badge:contains("Em Separação")');
        if (hasAtivos) {
            window.location.reload();
        }
    }, 300000); // 5 minutos
});
</script>
{% endblock %}
